/*
Deployment script for A2CDB

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar UserName "A2CUser"
:setvar DatabaseName "A2CDB"
:setvar DefaultFilePrefix "A2CDB"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF (SELECT is_default
    FROM   [$(DatabaseName)].[sys].[filegroups]
    WHERE  [name] = N'FileStream') = 0
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            MODIFY FILEGROUP [FileStream] DEFAULT;
    END


GO
USE [$(DatabaseName)];


GO
/*
 Pre-Deployment Script Template							
--------------------------------------------------------------------------------------
 This file contains SQL statements that will be executed before the build script.	
 Use SQLCMD syntax to include a file in the pre-deployment script.			
 Example:      :r .\myfile.sql								
 Use SQLCMD syntax to reference a variable in the pre-deployment script.		
 Example:      :setvar TableName MyTable							
               SELECT * FROM [$(TableName)]					
--------------------------------------------------------------------------------------
*/
/****************tmp Table creation**********/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE UNIQUE INDEX uq_A2CTransaction
ON A2CTransactions(A2CTransactionid)


CREATE UNIQUE INDEX uq_A2CTransactionRequest
ON A2CTransactionRequests (A2CTransactionRequestid)

CREATE UNIQUE INDEX uq_A2CTransactionResponseEnvelopes
ON A2CTransactionResponseEnvelopes (A2CTransactionResponseEnvelopeId)

CREATE UNIQUE INDEX uq_A2CTransactionResponseEnvelopeMessages
ON A2CTransactionResponseEnvelopeMessages (A2CTransactionResponseEnvelopeMessageId)


if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionEDIs' AND Type = N'U')
begin
CREATE TABLE [dbo].[tmpA2CTransactionEDIs](
	[A2CTransactionEDIId] [int],
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionId] [int] NOT NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[FileName] [nvarchar](100) NULL
) 
end
GO

if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionErrors' AND Type = N'U')
begin
CREATE TABLE [dbo].[tmpA2CTransactionErrors](
	[A2CTransactionErrorId] [int],
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionId] [int] NOT NULL,
	[ErrorDescription] [nvarchar](max) NULL,
	[LastModifiedDate] [datetime] NOT NULL
) 
end
GO

if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionMessages' AND Type = N'U')
begin

CREATE TABLE [dbo].[tmpA2CTransactionMessages](
	[A2CTransactionMessageId] [int] ,
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionId] [int] NOT NULL,
	[A2CMessageGuid] [uniqueidentifier] NOT NULL,
	[OutgoingSequence] [bigint] NOT NULL,
	[LastModifiedDate] [datetime] NOT NULL)

end
GO

if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionRequests' AND Type = N'U')
begin

CREATE TABLE [dbo].[tmpA2CTransactionRequests](
	[A2CTransactionRequestId] [int] ,
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionId] [int] NOT NULL,
	[A2CTransactionGuid] [nvarchar](50) NOT NULL,
	[EndPoint] [nvarchar](300) NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[Id] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
	[Envelope] [varbinary](max) FILESTREAM  NULL,
	 CONSTRAINT [UQ__A2CTrans__3214EC06A4AD1F241] UNIQUE NONCLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	)

end

GO


if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseEnvelopeEDIs' AND Type = N'U')
begin

CREATE TABLE [dbo].[tmpA2CTransactionResponseEnvelopeEDIs](
	[A2CTransactionResponseEnvelopeEDIId] [int] NOT NULL,
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionResponseEnvelopeId] [int] NOT NULL,
	[FileName] [nvarchar](100) NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[Id] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
	[data] [varbinary](max) FILESTREAM  NULL,
	[MessageAwardingOrganisationCentreId] [int] NULL,
	A2CTransactionMasterId int,
	 CONSTRAINT [UQ__A2CTrans__3214EC06A4AD1F2411] UNIQUE NONCLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	
	)	
	
	end

GO

if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseEnvelopeMessages' AND Type = N'U')
begin


CREATE TABLE [dbo].[tmpA2CTransactionResponseEnvelopeMessages](
	[A2CTransactionResponseEnvelopeMessageId] [int]  NOT NULL,
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionResponseEnvelopeId] [int] NOT NULL,
	[MessageId] [nvarchar](50) NULL,
	[RefMessageId] [nvarchar](50) NULL,
	[TimeStamp] [datetime] NULL,
	[A2CMessageId] [int] NULL,
	[A2CTransactionMasterId] [int] NULL,
	[IncomingSequence] [int] NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[Id] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
	[data] [varbinary](max) FILESTREAM  NULL,
	[IsFeedbackMessage] [bit] NULL,
	[DataImportStatus] [smallint] NULL,
	[MessageAwardingOrganisationCentreId] [int] NULL,
	[IsMessageLevelFeedbackMessage] [bit] NULL,
	 CONSTRAINT [UQ__A2CTrans__3214EC06A4AD1F24133] UNIQUE NONCLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	
	)

end
GO

if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseEnvelopes' AND Type = N'U')
begin


CREATE TABLE [dbo].[tmpA2CTransactionResponseEnvelopes](
	[A2CTransactionResponseEnvelopeId] [int] NOT NULL,
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionResponseId] [int] NOT NULL,
	[IsSignalMessage] [bit] NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[Id] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
	[ResponseEnvelope] [varbinary](max) FILESTREAM  NULL,
	[IsEDIMessage] [bit] NULL,
	 CONSTRAINT [UQ__A2CTrans__3214EC06A4AD1F241256] UNIQUE NONCLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	)


end

GO

if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseEnvelopeSignalErrors' AND Type = N'U')
begin
CREATE TABLE [dbo].[tmpA2CTransactionResponseEnvelopeSignalErrors](
	[A2CTransactionResponseEnvelopeSignalErrorId] [int] NOT NULL,
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionResponseEnvelopeSignalId] [int] NOT NULL,
	[ErrorCode] [nvarchar](50) NULL,
	[ErrorDetail] [nvarchar](max) NULL,
	[Origin] [nvarchar](max) NULL,
	[RefMessageId] [nvarchar](50) NULL,
	[Severity] [nvarchar](50) NULL,
	[ShortDescription] [nvarchar](50) NULL,
	[Category] [nvarchar](50) NULL,
	[Description] [nvarchar](max) NULL,
	[LastModifiedDate] [datetime] NOT NULL)

end
GO


if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseEnvelopeSignals' AND Type = N'U')
begin
CREATE TABLE [dbo].[tmpA2CTransactionResponseEnvelopeSignals](
	[A2CTransactionResponseEnvelopeSignalId] [int]  NOT NULL,
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionResponseEnvelopeId] [int] NOT NULL,
	[SignalResponseMasterId] [int] NULL,
	[LastModifiedDate] [datetime] NOT NULL)

end
GO

if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseErrors' AND Type = N'U')
begin
CREATE TABLE [dbo].[tmpA2CTransactionResponseErrors](
	[A2CTransactionResponseErrorId] [int] NOT NULL,
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionResponseId] [int] NOT NULL,
	[ErrorDescription] [nvarchar](max) NULL,
	[LastModifiedDate] [datetime] NOT NULL)

end
GO

if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponses' AND Type = N'U')
begin
CREATE TABLE [dbo].[tmpA2CTransactionResponses](
	[A2CTransactionResponseId] [int] NOT NULL,
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionRequestId] [int] NOT NULL,
	[TransactionResponseStatus] [nvarchar](200) NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[IsErrorAssociated] [bit] NULL)
end
GO


if not EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactions' AND Type = N'U')
begin
CREATE TABLE [dbo].[tmpA2CTransactions](
	[A2CTransactionId] [int] NOT NULL,
	[AwardingOrganisationCentreId] [int] NOT NULL,
	[A2CTransactionMasterId] [int] NOT NULL,
	[LastModifiedDate] [datetime] NOT NULL)
end
GO

declare @date date
declare @A2CTransactionId int
set @date= getutcdate()-6
select @A2CTransactionId=min(a2ctransactionid) from a2ctransactions where cast(lastmodifieddate as date)>=@date

declare @A2CTransactionResponseEnvelopeMessageId int
select @A2CTransactionResponseEnvelopeMessageId= min(t.A2CTransactionResponseEnvelopeMessageId) 
  FROM [dbo].[A2CTransactionResponseEnvelopeMessages]  t
  INNER JOIN A2CTransactionResponseEnvelopes ARE on 
  are.AwardingOrganisationCentreId=t.AwardingOrganisationCentreId and
  are.A2CTransactionResponseEnvelopeId=t.A2CTransactionResponseEnvelopeId
  INNER JOIN A2CTransactionResponses ARs on 
  are.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  are.A2CTransactionResponseId=ARs.A2CTransactionResponseId
  INNER JOIN A2CTransactionRequests AR on 
  AR.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  AR.A2CTransactionRequestId=ARs.A2CTransactionRequestId
  INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId

While(exists(select 1 from A2CTransactionResponseEnvelopeMessages where A2CTransactionResponseEnvelopeMessageId>=@A2CTransactionResponseEnvelopeMessageId))
begin

declare @A2CTransactionResponseEnvelopeMessageIdMin int
declare @A2CTransactionResponseEnvelopeMessageIdMax int
set @A2CTransactionResponseEnvelopeMessageIdMin= @A2CTransactionResponseEnvelopeMessageId 
set @A2CTransactionResponseEnvelopeMessageIdMax= @A2CTransactionResponseEnvelopeMessageId + 1

INSERT INTO [dbo].[tmpA2CTransactionResponseEnvelopeMessages]
           ([A2CTransactionResponseEnvelopeMessageId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseEnvelopeId]
           ,[MessageId]
           ,[RefMessageId]
           ,[TimeStamp]
           ,[A2CMessageId]
           ,[A2CTransactionMasterId]
           ,[IncomingSequence]
           ,[LastModifiedDate]
           ,[Id]
           ,[data]
           ,[IsFeedbackMessage]
           ,[DataImportStatus]
           ,[MessageAwardingOrganisationCentreId]
           ,[IsMessageLevelFeedbackMessage])
   SELECT [A2CTransactionResponseEnvelopeMessageId]
      ,[AwardingOrganisationCentreId]
      ,[A2CTransactionResponseEnvelopeId]
      ,[MessageId]
      ,[RefMessageId]
      ,[TimeStamp]
      ,[A2CMessageId]
      ,[A2CTransactionMasterId]
      ,[IncomingSequence]
      ,[LastModifiedDate]
      ,[Id]
      ,[data]
      ,[IsFeedbackMessage]
      ,[DataImportStatus]
      ,[MessageAwardingOrganisationCentreId]
      ,[IsMessageLevelFeedbackMessage]
  FROM [dbo].[A2CTransactionResponseEnvelopeMessages]
  where 
  A2CTransactionResponseEnvelopeMessageId >= @A2CTransactionResponseEnvelopeMessageIdMin
  and 
  A2CTransactionResponseEnvelopeMessageId <= @A2CTransactionResponseEnvelopeMessageIdMax
  
   set  @A2CTransactionResponseEnvelopeMessageId =  @A2CTransactionResponseEnvelopeMessageId + 2
  
end





INSERT INTO [dbo].[tmpA2CTransactionResponseEnvelopeEDIs]
           ([A2CTransactionResponseEnvelopeEDIId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseEnvelopeId]
           ,[FileName]
           ,[LastModifiedDate]
           ,[Id]
           ,[data]
           ,[MessageAwardingOrganisationCentreId])
     SELECT [A2CTransactionResponseEnvelopeEDIId]
      ,t.[AwardingOrganisationCentreId]
      ,t.[A2CTransactionResponseEnvelopeId]
      ,[FileName]
      ,t.[LastModifiedDate]
      ,t.[Id]
      ,[data]
      ,[MessageAwardingOrganisationCentreId]
  FROM [dbo].[A2CTransactionResponseEnvelopeEDIs] t
  INNER JOIN A2CTransactionResponseEnvelopes ARE on 
  are.AwardingOrganisationCentreId=t.AwardingOrganisationCentreId and
  are.A2CTransactionResponseEnvelopeId=t.A2CTransactionResponseEnvelopeId
  INNER JOIN A2CTransactionResponses ARs on 
  are.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  are.A2CTransactionResponseId=ARs.A2CTransactionResponseId
  INNER JOIN A2CTransactionRequests AR on 
  AR.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  AR.A2CTransactionRequestId=ARs.A2CTransactionRequestId
  INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId


  INSERT INTO [dbo].[tmpA2CTransactionResponseEnvelopeSignalErrors]
           ([A2CTransactionResponseEnvelopeSignalErrorId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseEnvelopeSignalId]
           ,[ErrorCode]
           ,[ErrorDetail]
           ,[Origin]
           ,[RefMessageId]
           ,[Severity]
           ,[ShortDescription]
           ,[Category]
           ,[Description]
           ,[LastModifiedDate])
   SELECT [A2CTransactionResponseEnvelopeSignalErrorId]
      ,t.[AwardingOrganisationCentreId]
      ,t.[A2CTransactionResponseEnvelopeSignalId]
      ,[ErrorCode]
      ,[ErrorDetail]
      ,[Origin]
      ,[RefMessageId]
      ,[Severity]
      ,[ShortDescription]
      ,[Category]
      ,[Description]
      ,t.[LastModifiedDate]
  FROM [dbo].[A2CTransactionResponseEnvelopeSignalErrors]
  t
  INNER JOIN A2CTransactionResponseEnvelopeSignals AREs on 
  AREs.AwardingOrganisationCentreId=t.AwardingOrganisationCentreId and
  AREs.A2CTransactionResponseEnvelopeSignalId=t.A2CTransactionResponseEnvelopeSignalId
  INNER JOIN A2CTransactionResponseEnvelopes ARE on 
  are.AwardingOrganisationCentreId=AREs.AwardingOrganisationCentreId and
  are.A2CTransactionResponseEnvelopeId=AREs.A2CTransactionResponseEnvelopeId
  INNER JOIN A2CTransactionResponses ARs on 
  are.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  are.A2CTransactionResponseId=ARs.A2CTransactionResponseId
  INNER JOIN A2CTransactionRequests AR on 
  AR.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  AR.A2CTransactionRequestId=ARs.A2CTransactionRequestId
  INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId

  INSERT INTO [dbo].[tmpA2CTransactionResponseEnvelopeSignals]
           ([A2CTransactionResponseEnvelopeSignalId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseEnvelopeId]
           ,[SignalResponseMasterId]
           ,[LastModifiedDate])
    SELECT [A2CTransactionResponseEnvelopeSignalId]
      ,t.[AwardingOrganisationCentreId]
      ,t.[A2CTransactionResponseEnvelopeId]
      ,[SignalResponseMasterId]
      ,t.[LastModifiedDate]
  FROM [dbo].[A2CTransactionResponseEnvelopeSignals] t
  INNER JOIN A2CTransactionResponseEnvelopes ARE on 
  are.AwardingOrganisationCentreId=t.AwardingOrganisationCentreId and
  are.A2CTransactionResponseEnvelopeId=t.A2CTransactionResponseEnvelopeId
  INNER JOIN A2CTransactionResponses ARs on 
  are.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  are.A2CTransactionResponseId=ARs.A2CTransactionResponseId
  INNER JOIN A2CTransactionRequests AR on 
  AR.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  AR.A2CTransactionRequestId=ARs.A2CTransactionRequestId
  INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId

  


declare @A2CTransactionResponseEnvelopeId  int  
select @A2CTransactionResponseEnvelopeId = min(ARE.A2CTransactionResponseEnvelopeId) from 
A2CTransactionResponseEnvelopes ARE 
  INNER JOIN A2CTransactionResponses ARs on 
  are.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  are.A2CTransactionResponseId=ARs.A2CTransactionResponseId
  INNER JOIN A2CTransactionRequests AR on 
  AR.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  AR.A2CTransactionRequestId=ARs.A2CTransactionRequestId
  INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId
While(exists(select 1 from A2CTransactionResponseEnvelopes where A2CTransactionResponseEnvelopeId>=@A2CTransactionResponseEnvelopeId))
begin
declare @A2CTransactionResponseEnvelopeIdMin int
declare @A2CTransactionResponseEnvelopeIdMax int
set @A2CTransactionResponseEnvelopeIdMin= @A2CTransactionResponseEnvelopeId 
set @A2CTransactionResponseEnvelopeIdMax= @A2CTransactionResponseEnvelopeId + 999

INSERT INTO [dbo].[tmpA2CTransactionResponseEnvelopes]
           ([A2CTransactionResponseEnvelopeId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseId]
           ,[IsSignalMessage]
           ,[LastModifiedDate]
           ,[Id]
           ,[ResponseEnvelope]
           ,[IsEDIMessage])
     SELECT [A2CTransactionResponseEnvelopeId]
      ,[AwardingOrganisationCentreId]
      ,[A2CTransactionResponseId]
      ,[IsSignalMessage]
      ,[LastModifiedDate]
      ,[Id]
      ,[ResponseEnvelope]
      ,[IsEDIMessage]
  FROM [dbo].[A2CTransactionResponseEnvelopes]
  WHERE A2CTransactionResponseEnvelopeId >= @A2CTransactionResponseEnvelopeIdMin and
  A2CTransactionResponseEnvelopeId <=@A2CTransactionResponseEnvelopeIdMax

  set @A2CTransactionResponseEnvelopeId = @A2CTransactionResponseEnvelopeId + 1000
  
  END

  INSERT INTO [dbo].[tmpA2CTransactionResponseErrors]
           ([A2CTransactionResponseErrorId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseId]
           ,[ErrorDescription]
           ,[LastModifiedDate])
    SELECT [A2CTransactionResponseErrorId]
      ,ARE.[AwardingOrganisationCentreId]
      ,ARE.[A2CTransactionResponseId]
      ,[ErrorDescription]
      ,ARE.[LastModifiedDate]
  FROM [dbo].[A2CTransactionResponseErrors] ARE 
  INNER JOIN A2CTransactionResponses ARs on 
  are.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  are.A2CTransactionResponseId=ARs.A2CTransactionResponseId
  INNER JOIN A2CTransactionRequests AR on 
  AR.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  AR.A2CTransactionRequestId=ARs.A2CTransactionRequestId
  INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId



    INSERT INTO [dbo].[tmpA2CTransactionResponses]
             ([A2CTransactionResponseId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionRequestId]
           ,[TransactionResponseStatus]
           ,[LastModifiedDate]
           ,[IsErrorAssociated])
   SELECT [A2CTransactionResponseId]
      ,ARs.[AwardingOrganisationCentreId]
      ,ARs.[A2CTransactionRequestId]
      ,[TransactionResponseStatus]
      ,ARs.[LastModifiedDate]
      ,[IsErrorAssociated]
  FROM [dbo].[A2CTransactionResponses] ARs  INNER JOIN A2CTransactionRequests AR on 
  AR.AwardingOrganisationCentreId=ARs.AwardingOrganisationCentreId and
  AR.A2CTransactionRequestId=ARs.A2CTransactionRequestId
  INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId

  
declare @A2CTransactionRequestId  int  
select @A2CTransactionRequestId = min(AR.A2CTransactionRequestId) from A2CTransactionRequests
AR INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId
While(exists(select 1 from A2CTransactionRequests where A2CTransactionRequestId>=@A2CTransactionRequestId))
begin
declare @A2CTransactionRequestIdMin int
declare @A2CTransactionRequestIdMax int
set @A2CTransactionRequestIdMin= @A2CTransactionRequestId 
set @A2CTransactionRequestIdMax= @A2CTransactionRequestId + 999

INSERT INTO [dbo].[tmpA2CTransactionRequests]
           ([A2CTransactionRequestId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionId]
           ,[A2CTransactionGuid]
           ,[EndPoint]
           ,[LastModifiedDate]
           ,[Id]
           ,[Envelope])
  SELECT [A2CTransactionRequestId]
      ,[AwardingOrganisationCentreId]
      ,[A2CTransactionId]
      ,[A2CTransactionGuid]
      ,[EndPoint]
      ,[LastModifiedDate]
      ,[Id]
      ,[Envelope]
  FROM [dbo].[A2CTransactionRequests]
  WHERE A2CTransactionRequestId >= @A2CTransactionRequestIdMin and
  A2CTransactionRequestId <=@A2CTransactionRequestIdMax

  set @A2CTransactionRequestId = @A2CTransactionRequestId + 1000
  
  END



  INSERT INTO [dbo].[tmpA2CTransactionErrors]
           ([A2CTransactionErrorId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionId]
           ,[ErrorDescription]
           ,[LastModifiedDate])
    SELECT [A2CTransactionErrorId]
      ,AR.[AwardingOrganisationCentreId]
      ,AR.[A2CTransactionId]
      ,[ErrorDescription]
      ,AR.[LastModifiedDate]
  FROM [dbo].[A2CTransactionErrors]
AR INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId



INSERT INTO [dbo].[tmpA2CTransactionMessages]
           ([A2CTransactionMessageId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionId]
           ,[A2CMessageGuid]
           ,[OutgoingSequence]
           ,[LastModifiedDate])
    SELECT [A2CTransactionMessageId]
      ,AR.[AwardingOrganisationCentreId]
      ,AR.[A2CTransactionId]
      ,[A2CMessageGuid]
      ,[OutgoingSequence]
      ,AR.[LastModifiedDate]
  FROM [dbo].[A2CTransactionMessages]
AR INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId


  INSERT INTO [dbo].[tmpA2CTransactionEDIs]
           ([A2CTransactionEDIId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionId]
           ,[LastModifiedDate]
           ,[FileName])
   SELECT [A2CTransactionEDIId]
      ,AR.[AwardingOrganisationCentreId]
      ,AR.[A2CTransactionId]
      ,AR.[LastModifiedDate]
      ,[FileName]
	FROM [dbo].[A2CTransactionEDIs]
	AR INNER JOIN A2CTransactions At on 
  AR.AwardingOrganisationCentreId=At.AwardingOrganisationCentreId and
  AR.A2CTransactionId=At.A2CTransactionId
    where 
	at.A2CTransactionId>=@A2CTransactionId

	
INSERT INTO [dbo].[tmpA2CTransactions]
           ([A2CTransactionId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionMasterId]
           ,[LastModifiedDate])
SELECT AR.[A2CTransactionId]
      ,AR.[AwardingOrganisationCentreId]
      ,AR.[A2CTransactionMasterId]
      ,AR.[LastModifiedDate]
  FROM [dbo].[A2CTransactions]
  AR 
    where 
	ar.A2CTransactionId>=@A2CTransactionId


ALTER TABLE [dbo].[A2CTransactionResponses] DROP CONSTRAINT [FK_A2CTransactionResponses_A2CTransactionRequests]

ALTER TABLE [dbo].[A2CTransactionResponseErrors] DROP CONSTRAINT [FK_A2CTransactionResponseErrors_A2CTransactionResponses]

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignals] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignals_A2CTransactionResponseEnvelopes]

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignalErrors] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignalErrors_A2CTransactionResponseEnvelopeSignals]

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopes] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopes_A2CTransactionResponses]

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeMessages_A2CTransactionResponseEnvelopes]

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionResponseEnvelopes]

ALTER TABLE [dbo].[A2CTransactionRequests] DROP CONSTRAINT [FK_A2CTransactionRequests_A2CTransactions]

ALTER TABLE [dbo].[A2CTransactionMessages] DROP CONSTRAINT [FK_A2CTransactionMessages_A2CTransactions]

ALTER TABLE [dbo].[A2CTransactionErrors] DROP CONSTRAINT [FK_A2CTransactionErrors_A2CTransactions]

ALTER TABLE [dbo].[A2CTransactionEDIs] DROP CONSTRAINT [FK_A2CTransactionEDIs_A2CTransactions]

truncate table A2CTransactionResponseEnvelopeMessages
truncate table A2CTransactionResponseEnvelopeEDIs
truncate table A2CTransactionResponseEnvelopeSignalErrors
truncate table A2CTransactionResponseEnvelopeSignals
truncate table A2CTransactionResponseEnvelopes
truncate table A2CTransactionResponseErrors
truncate table A2CTransactionResponses
truncate table A2CTransactionEDIs
truncate table A2CTransactionErrors
truncate table A2CTransactionMessages
truncate table A2CTransactionRequests
truncate table A2CTransactions

ALTER TABLE [dbo].[A2CTransactionEDIs]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionEDIs_A2CTransactions] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionId])
REFERENCES [dbo].[A2CTransactions] ([AwardingOrganisationCentreId], [A2CTransactionId])

ALTER TABLE [dbo].[A2CTransactionErrors]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionErrors_A2CTransactions] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionId])
REFERENCES [dbo].[A2CTransactions] ([AwardingOrganisationCentreId], [A2CTransactionId])

ALTER TABLE [dbo].[A2CTransactionMessages]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionMessages_A2CTransactions] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionId])
REFERENCES [dbo].[A2CTransactions] ([AwardingOrganisationCentreId], [A2CTransactionId])

ALTER TABLE [dbo].[A2CTransactionRequests]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionRequests_A2CTransactions] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionId])
REFERENCES [dbo].[A2CTransactions] ([AwardingOrganisationCentreId], [A2CTransactionId])

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionResponseEnvelopes] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeId])
REFERENCES [dbo].[A2CTransactionResponseEnvelopes] ([AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeId])

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionResponseEnvelopeMessages_A2CTransactionResponseEnvelopes] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeId])
REFERENCES [dbo].[A2CTransactionResponseEnvelopes] ([AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeId])

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopes]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionResponseEnvelopes_A2CTransactionResponses] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionResponseId])
REFERENCES [dbo].[A2CTransactionResponses] ([AwardingOrganisationCentreId], [A2CTransactionResponseId])

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignalErrors]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignalErrors_A2CTransactionResponseEnvelopeSignals] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeSignalId])
REFERENCES [dbo].[A2CTransactionResponseEnvelopeSignals] ([AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeSignalId])

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignals]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignals_A2CTransactionResponseEnvelopes] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeId])
REFERENCES [dbo].[A2CTransactionResponseEnvelopes] ([AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeId])


ALTER TABLE [dbo].[A2CTransactionResponseErrors]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionResponseErrors_A2CTransactionResponses] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionResponseId])
REFERENCES [dbo].[A2CTransactionResponses] ([AwardingOrganisationCentreId], [A2CTransactionResponseId])

ALTER TABLE [dbo].[A2CTransactionResponses]  WITH CHECK ADD  CONSTRAINT [FK_A2CTransactionResponses_A2CTransactionRequests] FOREIGN KEY([AwardingOrganisationCentreId], [A2CTransactionRequestId])
REFERENCES [dbo].[A2CTransactionRequests] ([AwardingOrganisationCentreId], [A2CTransactionRequestId])

drop INDEX uq_A2CTransaction on A2CTransactions

drop INDEX uq_A2CTransactionRequest on A2CTransactionRequests

drop INDEX uq_A2CTransactionResponseEnvelopes on A2CTransactionResponseEnvelopes

drop INDEX uq_A2CTransactionResponseEnvelopeMessages on A2CTransactionResponseEnvelopeMessages

GO

GO
PRINT N'Dropping [dbo].[DF_A2CTransactionEDIs_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionEDIs] DROP CONSTRAINT [DF_A2CTransactionEDIs_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionErrors_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionErrors] DROP CONSTRAINT [DF_A2CTransactionErrors_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionMessages_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionMessages] DROP CONSTRAINT [DF_A2CTransactionMessages_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF__A2CTransacti__Id__0D99FE17]...';


GO
ALTER TABLE [dbo].[A2CTransactionRequests] DROP CONSTRAINT [DF__A2CTransacti__Id__0D99FE17];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionRequests_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionRequests] DROP CONSTRAINT [DF_A2CTransactionRequests_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF__A2CTransacti__Id__24285DB4]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] DROP CONSTRAINT [DF__A2CTransacti__Id__24285DB4];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionResponseEDIs_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] DROP CONSTRAINT [DF_A2CTransactionResponseEDIs_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionResponseEnvelopeEDIs_IsResultFile]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] DROP CONSTRAINT [DF_A2CTransactionResponseEnvelopeEDIs_IsResultFile];


GO
PRINT N'Dropping [dbo].[DF__A2CTransacti__Id__27F8EE98]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] DROP CONSTRAINT [DF__A2CTransacti__Id__27F8EE98];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionResponseEnvelopeMessages_DataImportStatus]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] DROP CONSTRAINT [DF_A2CTransactionResponseEnvelopeMessages_DataImportStatus];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionResponseMessages_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] DROP CONSTRAINT [DF_A2CTransactionResponseMessages_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF__A2CTransacti__Id__34B3CB38]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopes] DROP CONSTRAINT [DF__A2CTransacti__Id__34B3CB38];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionResponseEnvelopes_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopes] DROP CONSTRAINT [DF_A2CTransactionResponseEnvelopes_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionResponseEnvelopeSignalErrors_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignalErrors] DROP CONSTRAINT [DF_A2CTransactionResponseEnvelopeSignalErrors_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionResponseSignals_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignals] DROP CONSTRAINT [DF_A2CTransactionResponseSignals_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionResponseExceptions_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseErrors] DROP CONSTRAINT [DF_A2CTransactionResponseExceptions_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactionResponses_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponses] DROP CONSTRAINT [DF_A2CTransactionResponses_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[DF_A2CTransactions_LastModifiedDate]...';


GO
ALTER TABLE [dbo].[A2CTransactions] DROP CONSTRAINT [DF_A2CTransactions_LastModifiedDate];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionEDIs_A2CTransactions]...';


GO
ALTER TABLE [dbo].[A2CTransactionEDIs] DROP CONSTRAINT [FK_A2CTransactionEDIs_A2CTransactions];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionErrors_A2CTransactions]...';


GO
ALTER TABLE [dbo].[A2CTransactionErrors] DROP CONSTRAINT [FK_A2CTransactionErrors_A2CTransactions];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionMessages_A2CTransactions]...';


GO
ALTER TABLE [dbo].[A2CTransactionMessages] DROP CONSTRAINT [FK_A2CTransactionMessages_A2CTransactions];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionRequests_A2CTransactions]...';


GO
ALTER TABLE [dbo].[A2CTransactionRequests] DROP CONSTRAINT [FK_A2CTransactionRequests_A2CTransactions];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponses_A2CTransactionRequests]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponses] DROP CONSTRAINT [FK_A2CTransactionResponses_A2CTransactionRequests];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionMasters]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionMasters];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionResponseEnvelopes]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionResponseEnvelopes];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseEnvelopeEDIs_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_AwardingOrganisationCentres];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseEnvelopeMessages_A2CTransactionMasters]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeMessages_A2CTransactionMasters];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseEnvelopeMessages_A2CTransactionResponseEnvelopes]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeMessages_A2CTransactionResponseEnvelopes];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseEnvelopeMessages_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeMessages_AwardingOrganisationCentres];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseEnvelopes_A2CTransactionResponses]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopes] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopes_A2CTransactionResponses];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseEnvelopeSignals_A2CTransactionResponseEnvelopes]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignals] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignals_A2CTransactionResponseEnvelopes];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseEnvelopeSignalErrors_A2CTransactionResponseEnvelopeSignals]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignalErrors] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignalErrors_A2CTransactionResponseEnvelopeSignals];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseEnvelopeSignals_SignalResponseMasters]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignals] DROP CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignals_SignalResponseMasters];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactionResponseErrors_A2CTransactionResponses]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseErrors] DROP CONSTRAINT [FK_A2CTransactionResponseErrors_A2CTransactionResponses];


GO
PRINT N'Dropping [dbo].[FK_A2CTransactions_AwardingOrganizationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactions] DROP CONSTRAINT [FK_A2CTransactions_AwardingOrganizationCentres];


GO
/*
The column [dbo].[A2CTransactionEDIs].[SchoolId] on table [dbo].[A2CTransactionEDIs] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionEDIs]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionEDIs] (
    [A2CTransactionEDIId]          INT            IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                     INT            NOT NULL,
    [AwardingOrganisationCentreId] INT            NOT NULL,
    [A2CTransactionId]             INT            NOT NULL,
    [LastModifiedDate]             DATETIME       CONSTRAINT [DF_A2CTransactionEDIs_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    [FileName]                     NVARCHAR (100) NULL,
    CONSTRAINT [tmp_ms_xx_constraint_pk_A2CTransactionEDIs] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionEDIId] ASC) WITH (FILLFACTOR = 75, PAD_INDEX = ON)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionEDIs])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionEDIs] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionEDIs] ([A2CTransactionEDIId], [AwardingOrganisationCentreId], [A2CTransactionId], [LastModifiedDate], [FileName])
        SELECT   [A2CTransactionEDIId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionId],
                 [LastModifiedDate],
                 [FileName]
        FROM     [dbo].[A2CTransactionEDIs]
        ORDER BY [A2CTransactionEDIId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionEDIs] OFF;
    END

DROP TABLE [dbo].[A2CTransactionEDIs];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionEDIs]', N'A2CTransactionEDIs';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_pk_A2CTransactionEDIs]', N'pk_A2CTransactionEDIs', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactionErrors].[SchoolId] on table [dbo].[A2CTransactionErrors] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionErrors]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionErrors] (
    [A2CTransactionErrorId]        INT            IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                     INT            NOT NULL,
    [AwardingOrganisationCentreId] INT            NOT NULL,
    [A2CTransactionId]             INT            NOT NULL,
    [ErrorDescription]             NVARCHAR (MAX) NULL,
    [LastModifiedDate]             DATETIME       CONSTRAINT [DF_A2CTransactionErrors_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_pk_A2CTransactionErrors] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionErrorId] ASC) WITH (FILLFACTOR = 75, PAD_INDEX = ON)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionErrors])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionErrors] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionErrors] ([A2CTransactionErrorId], [AwardingOrganisationCentreId], [A2CTransactionId], [ErrorDescription], [LastModifiedDate])
        SELECT   [A2CTransactionErrorId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionId],
                 [ErrorDescription],
                 [LastModifiedDate]
        FROM     [dbo].[A2CTransactionErrors]
        ORDER BY [A2CTransactionErrorId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionErrors] OFF;
    END

DROP TABLE [dbo].[A2CTransactionErrors];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionErrors]', N'A2CTransactionErrors';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_pk_A2CTransactionErrors]', N'pk_A2CTransactionErrors', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactionMessages].[SchoolId] on table [dbo].[A2CTransactionMessages] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionMessages]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionMessages] (
    [A2CTransactionMessageId]      INT              IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                     INT              NOT NULL,
    [AwardingOrganisationCentreId] INT              NOT NULL,
    [A2CTransactionId]             INT              NOT NULL,
    [A2CMessageGuid]               UNIQUEIDENTIFIER NOT NULL,
    [OutgoingSequence]             BIGINT           NOT NULL,
    [LastModifiedDate]             DATETIME         CONSTRAINT [DF_A2CTransactionMessages_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_pk_A2CTransactionMessages] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionMessageId] ASC) WITH (FILLFACTOR = 75, PAD_INDEX = ON)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionMessages])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionMessages] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionMessages] ([A2CTransactionMessageId], [AwardingOrganisationCentreId], [A2CTransactionId], [A2CMessageGuid], [OutgoingSequence], [LastModifiedDate])
        SELECT   [A2CTransactionMessageId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionId],
                 [A2CMessageGuid],
                 [OutgoingSequence],
                 [LastModifiedDate]
        FROM     [dbo].[A2CTransactionMessages]
        ORDER BY [A2CTransactionMessageId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionMessages] OFF;
    END

DROP TABLE [dbo].[A2CTransactionMessages];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionMessages]', N'A2CTransactionMessages';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_pk_A2CTransactionMessages]', N'pk_A2CTransactionMessages', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactionRequests].[SchoolId] on table [dbo].[A2CTransactionRequests] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionRequests]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionRequests] (
    [A2CTransactionRequestId]      INT                        IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                     INT                        NOT NULL,
    [AwardingOrganisationCentreId] INT                        NOT NULL,
    [A2CTransactionId]             INT                        NOT NULL,
    [A2CTransactionGuid]           NVARCHAR (50)              NOT NULL,
    [EndPoint]                     NVARCHAR (300)             NULL,
    [LastModifiedDate]             DATETIME                   CONSTRAINT [DF_A2CTransactionRequests_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    [Id]                           UNIQUEIDENTIFIER           CONSTRAINT [DF__A2CTransacti__Id__0D99FE17] DEFAULT (newid()) ROWGUIDCOL NOT NULL,
    [Envelope]                     VARBINARY (MAX) FILESTREAM NULL,
    CONSTRAINT [tmp_ms_xx_constraint_pk_A2CTransactionRequests] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionRequestId] ASC) WITH (FILLFACTOR = 75, PAD_INDEX = ON),
    CONSTRAINT [tmp_ms_xx_constraint_UQ__A2CTrans__3214EC06A4AD1F24] UNIQUE NONCLUSTERED ([Id] ASC)
) FILESTREAM_ON [FileStream];

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionRequests])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionRequests] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionRequests] ([A2CTransactionRequestId], [AwardingOrganisationCentreId], [A2CTransactionId], [A2CTransactionGuid], [EndPoint], [LastModifiedDate], [Id], [Envelope])
        SELECT   [A2CTransactionRequestId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionId],
                 [A2CTransactionGuid],
                 [EndPoint],
                 [LastModifiedDate],
                 [Id],
                 [Envelope]
        FROM     [dbo].[A2CTransactionRequests]
        ORDER BY [A2CTransactionRequestId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionRequests] OFF;
    END

DROP TABLE [dbo].[A2CTransactionRequests];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionRequests]', N'A2CTransactionRequests';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_pk_A2CTransactionRequests]', N'pk_A2CTransactionRequests', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_UQ__A2CTrans__3214EC06A4AD1F24]', N'UQ__A2CTrans__3214EC06A4AD1F24', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactionResponseEnvelopeEDIs].[IsResultFile] is being dropped, data loss could occur.

The column [dbo].[A2CTransactionResponseEnvelopeEDIs].[SchoolId] on table [dbo].[A2CTransactionResponseEnvelopeEDIs] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionResponseEnvelopeEDIs]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeEDIs] (
    [A2CTransactionResponseEnvelopeEDIId] INT                        IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                            INT                        NOT NULL,
    [AwardingOrganisationCentreId]        INT                        NOT NULL,
    [A2CTransactionResponseEnvelopeId]    INT                        NOT NULL,
    [FileName]                            NVARCHAR (100)             NULL,
    [LastModifiedDate]                    DATETIME                   CONSTRAINT [DF_A2CTransactionResponseEDIs_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    [Id]                                  UNIQUEIDENTIFIER           CONSTRAINT [DF__A2CTransacti__Id__24285DB4] DEFAULT (newid()) ROWGUIDCOL NOT NULL,
    [data]                                VARBINARY (MAX) FILESTREAM NULL,
    [MessageAwardingOrganisationCentreId] INT                        NULL,
    [A2CTransactionMasterId]              INT                        NULL,
    CONSTRAINT [tmp_ms_xx_constraint_pk_A2CTransactionResponseEnvelopeEDIs] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionResponseEnvelopeEDIId] ASC) WITH (FILLFACTOR = 75, PAD_INDEX = ON),
    CONSTRAINT [tmp_ms_xx_constraint_UQ__A2CTrans__3214EC06C5BC8BDB] UNIQUE NONCLUSTERED ([Id] ASC)
) FILESTREAM_ON [FileStream];

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionResponseEnvelopeEDIs])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeEDIs] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeEDIs] ([A2CTransactionResponseEnvelopeEDIId], [AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeId], [FileName], [LastModifiedDate], [Id], [data], [MessageAwardingOrganisationCentreId], [A2CTransactionMasterId])
        SELECT   [A2CTransactionResponseEnvelopeEDIId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionResponseEnvelopeId],
                 [FileName],
                 [LastModifiedDate],
                 [Id],
                 [data],
                 [MessageAwardingOrganisationCentreId],
                 [A2CTransactionMasterId]
        FROM     [dbo].[A2CTransactionResponseEnvelopeEDIs]
        ORDER BY [A2CTransactionResponseEnvelopeEDIId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeEDIs] OFF;
    END

DROP TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeEDIs]', N'A2CTransactionResponseEnvelopeEDIs';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_pk_A2CTransactionResponseEnvelopeEDIs]', N'pk_A2CTransactionResponseEnvelopeEDIs', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_UQ__A2CTrans__3214EC06C5BC8BDB]', N'UQ__A2CTrans__3214EC06C5BC8BDB', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactionResponseEnvelopeMessages].[SchoolId] on table [dbo].[A2CTransactionResponseEnvelopeMessages] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionResponseEnvelopeMessages]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeMessages] (
    [A2CTransactionResponseEnvelopeMessageId] INT                        IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                                INT                        NOT NULL,
    [AwardingOrganisationCentreId]            INT                        NOT NULL,
    [A2CTransactionResponseEnvelopeId]        INT                        NOT NULL,
    [MessageId]                               NVARCHAR (50)              NULL,
    [RefMessageId]                            NVARCHAR (50)              NULL,
    [TimeStamp]                               DATETIME                   NULL,
    [A2CMessageId]                            INT                        NULL,
    [A2CTransactionMasterId]                  INT                        NULL,
    [IncomingSequence]                        INT                        NULL,
    [LastModifiedDate]                        DATETIME                   CONSTRAINT [DF_A2CTransactionResponseMessages_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    [Id]                                      UNIQUEIDENTIFIER           CONSTRAINT [DF__A2CTransacti__Id__27F8EE98] DEFAULT (newid()) ROWGUIDCOL NOT NULL,
    [data]                                    VARBINARY (MAX) FILESTREAM NULL,
    [IsFeedbackMessage]                       BIT                        NULL,
    [DataImportStatus]                        SMALLINT                   CONSTRAINT [DF_A2CTransactionResponseEnvelopeMessages_DataImportStatus] DEFAULT ((0)) NULL,
    [MessageAwardingOrganisationCentreId]     INT                        NULL,
    [IsMessageLevelFeedbackMessage]           BIT                        NULL,
    CONSTRAINT [tmp_ms_xx_constraint_pk_A2CTransactionResponseEnvelopeMessages] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionResponseEnvelopeMessageId] ASC) WITH (FILLFACTOR = 75, PAD_INDEX = ON),
    CONSTRAINT [tmp_ms_xx_constraint_UQ__A2CTrans__3214EC06E7A133DC] UNIQUE NONCLUSTERED ([Id] ASC)
) FILESTREAM_ON [FileStream];

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionResponseEnvelopeMessages])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeMessages] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeMessages] ([A2CTransactionResponseEnvelopeMessageId], [AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeId], [MessageId], [RefMessageId], [TimeStamp], [A2CMessageId], [A2CTransactionMasterId], [IncomingSequence], [LastModifiedDate], [Id], [data], [IsFeedbackMessage], [DataImportStatus], [MessageAwardingOrganisationCentreId], [IsMessageLevelFeedbackMessage])
        SELECT   [A2CTransactionResponseEnvelopeMessageId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionResponseEnvelopeId],
                 [MessageId],
                 [RefMessageId],
                 [TimeStamp],
                 [A2CMessageId],
                 [A2CTransactionMasterId],
                 [IncomingSequence],
                 [LastModifiedDate],
                 [Id],
                 [data],
                 [IsFeedbackMessage],
                 [DataImportStatus],
                 [MessageAwardingOrganisationCentreId],
                 [IsMessageLevelFeedbackMessage]
        FROM     [dbo].[A2CTransactionResponseEnvelopeMessages]
        ORDER BY [A2CTransactionResponseEnvelopeMessageId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeMessages] OFF;
    END

DROP TABLE [dbo].[A2CTransactionResponseEnvelopeMessages];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeMessages]', N'A2CTransactionResponseEnvelopeMessages';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_pk_A2CTransactionResponseEnvelopeMessages]', N'pk_A2CTransactionResponseEnvelopeMessages', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_UQ__A2CTrans__3214EC06E7A133DC]', N'UQ__A2CTrans__3214EC06E7A133DC', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactionResponseEnvelopes].[SchoolId] on table [dbo].[A2CTransactionResponseEnvelopes] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionResponseEnvelopes]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopes] (
    [A2CTransactionResponseEnvelopeId] INT                        IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                         INT                        NOT NULL,
    [AwardingOrganisationCentreId]     INT                        NOT NULL,
    [A2CTransactionResponseId]         INT                        NOT NULL,
    [IsSignalMessage]                  BIT                        NULL,
    [LastModifiedDate]                 DATETIME                   CONSTRAINT [DF_A2CTransactionResponseEnvelopes_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    [Id]                               UNIQUEIDENTIFIER           CONSTRAINT [DF__A2CTransacti__Id__34B3CB38] DEFAULT (newid()) ROWGUIDCOL NOT NULL,
    [ResponseEnvelope]                 VARBINARY (MAX) FILESTREAM NULL,
    [IsEDIMessage]                     BIT                        NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_A2CTransactionResponseEnvelopes] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionResponseEnvelopeId] ASC) WITH (FILLFACTOR = 75, PAD_INDEX = ON),
    CONSTRAINT [tmp_ms_xx_constraint_UQ__A2CTrans__3214EC068F756BDD] UNIQUE NONCLUSTERED ([Id] ASC)
) FILESTREAM_ON [FileStream];

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionResponseEnvelopes])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopes] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopes] ([A2CTransactionResponseEnvelopeId], [AwardingOrganisationCentreId], [A2CTransactionResponseId], [IsSignalMessage], [LastModifiedDate], [Id], [ResponseEnvelope], [IsEDIMessage])
        SELECT   [A2CTransactionResponseEnvelopeId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionResponseId],
                 [IsSignalMessage],
                 [LastModifiedDate],
                 [Id],
                 [ResponseEnvelope],
                 [IsEDIMessage]
        FROM     [dbo].[A2CTransactionResponseEnvelopes]
        ORDER BY [A2CTransactionResponseEnvelopeId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopes] OFF;
    END

DROP TABLE [dbo].[A2CTransactionResponseEnvelopes];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopes]', N'A2CTransactionResponseEnvelopes';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_A2CTransactionResponseEnvelopes]', N'PK_A2CTransactionResponseEnvelopes', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_UQ__A2CTrans__3214EC068F756BDD]', N'UQ__A2CTrans__3214EC068F756BDD', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactionResponseEnvelopeSignalErrors].[SchoolId] on table [dbo].[A2CTransactionResponseEnvelopeSignalErrors] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionResponseEnvelopeSignalErrors]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeSignalErrors] (
    [A2CTransactionResponseEnvelopeSignalErrorId] INT            IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                                    INT            NOT NULL,
    [AwardingOrganisationCentreId]                INT            NOT NULL,
    [A2CTransactionResponseEnvelopeSignalId]      INT            NOT NULL,
    [ErrorCode]                                   NVARCHAR (50)  NULL,
    [ErrorDetail]                                 NVARCHAR (MAX) NULL,
    [Origin]                                      NVARCHAR (MAX) NULL,
    [RefMessageId]                                NVARCHAR (50)  NULL,
    [Severity]                                    NVARCHAR (50)  NULL,
    [ShortDescription]                            NVARCHAR (50)  NULL,
    [Category]                                    NVARCHAR (50)  NULL,
    [Description]                                 NVARCHAR (MAX) NULL,
    [LastModifiedDate]                            DATETIME       CONSTRAINT [DF_A2CTransactionResponseEnvelopeSignalErrors_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_A2CTransactionResponseEnvelopeSignalErrors] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionResponseEnvelopeSignalErrorId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionResponseEnvelopeSignalErrors])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeSignalErrors] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeSignalErrors] ([A2CTransactionResponseEnvelopeSignalErrorId], [AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeSignalId], [ErrorCode], [ErrorDetail], [Origin], [RefMessageId], [Severity], [ShortDescription], [Category], [Description], [LastModifiedDate])
        SELECT   [A2CTransactionResponseEnvelopeSignalErrorId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionResponseEnvelopeSignalId],
                 [ErrorCode],
                 [ErrorDetail],
                 [Origin],
                 [RefMessageId],
                 [Severity],
                 [ShortDescription],
                 [Category],
                 [Description],
                 [LastModifiedDate]
        FROM     [dbo].[A2CTransactionResponseEnvelopeSignalErrors]
        ORDER BY [A2CTransactionResponseEnvelopeSignalErrorId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeSignalErrors] OFF;
    END

DROP TABLE [dbo].[A2CTransactionResponseEnvelopeSignalErrors];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeSignalErrors]', N'A2CTransactionResponseEnvelopeSignalErrors';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_A2CTransactionResponseEnvelopeSignalErrors]', N'PK_A2CTransactionResponseEnvelopeSignalErrors', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactionResponseEnvelopeSignals].[SchoolId] on table [dbo].[A2CTransactionResponseEnvelopeSignals] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionResponseEnvelopeSignals]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeSignals] (
    [A2CTransactionResponseEnvelopeSignalId] INT      IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                               INT      NOT NULL,
    [AwardingOrganisationCentreId]           INT      NOT NULL,
    [A2CTransactionResponseEnvelopeId]       INT      NOT NULL,
    [SignalResponseMasterId]                 INT      NULL,
    [LastModifiedDate]                       DATETIME CONSTRAINT [DF_A2CTransactionResponseSignals_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_A2CTransactionResponseEnvelopeSignals] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionResponseEnvelopeSignalId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionResponseEnvelopeSignals])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeSignals] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeSignals] ([A2CTransactionResponseEnvelopeSignalId], [AwardingOrganisationCentreId], [A2CTransactionResponseEnvelopeId], [SignalResponseMasterId], [LastModifiedDate])
        SELECT   [A2CTransactionResponseEnvelopeSignalId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionResponseEnvelopeId],
                 [SignalResponseMasterId],
                 [LastModifiedDate]
        FROM     [dbo].[A2CTransactionResponseEnvelopeSignals]
        ORDER BY [A2CTransactionResponseEnvelopeSignalId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeSignals] OFF;
    END

DROP TABLE [dbo].[A2CTransactionResponseEnvelopeSignals];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionResponseEnvelopeSignals]', N'A2CTransactionResponseEnvelopeSignals';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_A2CTransactionResponseEnvelopeSignals]', N'PK_A2CTransactionResponseEnvelopeSignals', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactionResponseErrors].[SchoolId] on table [dbo].[A2CTransactionResponseErrors] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionResponseErrors]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionResponseErrors] (
    [A2CTransactionResponseErrorId] INT            IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                      INT            NOT NULL,
    [AwardingOrganisationCentreId]  INT            NOT NULL,
    [A2CTransactionResponseId]      INT            NOT NULL,
    [ErrorDescription]              NVARCHAR (MAX) NULL,
    [LastModifiedDate]              DATETIME       CONSTRAINT [DF_A2CTransactionResponseExceptions_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_A2CTransactionResponseErrors] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionResponseErrorId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionResponseErrors])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseErrors] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionResponseErrors] ([A2CTransactionResponseErrorId], [AwardingOrganisationCentreId], [A2CTransactionResponseId], [ErrorDescription], [LastModifiedDate])
        SELECT   [A2CTransactionResponseErrorId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionResponseId],
                 [ErrorDescription],
                 [LastModifiedDate]
        FROM     [dbo].[A2CTransactionResponseErrors]
        ORDER BY [A2CTransactionResponseErrorId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponseErrors] OFF;
    END

DROP TABLE [dbo].[A2CTransactionResponseErrors];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionResponseErrors]', N'A2CTransactionResponseErrors';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_A2CTransactionResponseErrors]', N'PK_A2CTransactionResponseErrors', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactionResponses].[SchoolId] on table [dbo].[A2CTransactionResponses] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactionResponses]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactionResponses] (
    [A2CTransactionResponseId]     INT            IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                     INT            NOT NULL,
    [AwardingOrganisationCentreId] INT            NOT NULL,
    [A2CTransactionRequestId]      INT            NOT NULL,
    [TransactionResponseStatus]    NVARCHAR (200) NULL,
    [LastModifiedDate]             DATETIME       CONSTRAINT [DF_A2CTransactionResponses_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    [IsErrorAssociated]            BIT            NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_A2CTransactionResponses] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionResponseId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactionResponses])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponses] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactionResponses] ([A2CTransactionResponseId], [AwardingOrganisationCentreId], [A2CTransactionRequestId], [TransactionResponseStatus], [LastModifiedDate], [IsErrorAssociated])
        SELECT   [A2CTransactionResponseId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionRequestId],
                 [TransactionResponseStatus],
                 [LastModifiedDate],
                 [IsErrorAssociated]
        FROM     [dbo].[A2CTransactionResponses]
        ORDER BY [A2CTransactionResponseId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactionResponses] OFF;
    END

DROP TABLE [dbo].[A2CTransactionResponses];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactionResponses]', N'A2CTransactionResponses';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_A2CTransactionResponses]', N'PK_A2CTransactionResponses', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
/*
The column [dbo].[A2CTransactions].[SchoolId] on table [dbo].[A2CTransactions] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/
GO
PRINT N'Starting rebuilding table [dbo].[A2CTransactions]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_A2CTransactions] (
    [A2CTransactionId]             INT      IDENTITY (1000, 1) NOT NULL,
    [SchoolId]                     INT      NOT NULL,
    [AwardingOrganisationCentreId] INT      NOT NULL,
    [A2CTransactionMasterId]       INT      NOT NULL,
    [LastModifiedDate]             DATETIME CONSTRAINT [DF_A2CTransactions_LastModifiedDate] DEFAULT (getutcdate()) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_A2CTransactions] PRIMARY KEY CLUSTERED ([SchoolId] ASC, [A2CTransactionId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[A2CTransactions])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactions] ON;
        INSERT INTO [dbo].[tmp_ms_xx_A2CTransactions] ([A2CTransactionId], [AwardingOrganisationCentreId], [A2CTransactionMasterId], [LastModifiedDate])
        SELECT   [A2CTransactionId],
                 [AwardingOrganisationCentreId],
                 [A2CTransactionMasterId],
                 [LastModifiedDate]
        FROM     [dbo].[A2CTransactions]
        ORDER BY [A2CTransactionId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_A2CTransactions] OFF;
    END

DROP TABLE [dbo].[A2CTransactions];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_A2CTransactions]', N'A2CTransactions';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_A2CTransactions]', N'PK_A2CTransactions', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [dbo].[SchoolConfigurations]...';


GO
CREATE TABLE [dbo].[SchoolConfigurations] (
    [SchoolConfigurationId]               INT            IDENTITY (1000, 1) NOT NULL,
    [SchoolID]                            INT            NOT NULL,
    [ContactEmail]                        NVARCHAR (256) NOT NULL,
    [ContactPhoneNumber]                  NVARCHAR (50)  NOT NULL,
    [NumberofAttemptCheckForAOConnection] SMALLINT       NOT NULL,
    [LastModified]                        DATETIME       NOT NULL,
    CONSTRAINT [PK_SchoolConfigurations] PRIMARY KEY CLUSTERED ([SchoolConfigurationId] ASC, [SchoolID] ASC)
);


GO
PRINT N'Creating [dbo].[DF_SchoolConfigurations_LastModified]...';


GO
ALTER TABLE [dbo].[SchoolConfigurations]
    ADD CONSTRAINT [DF_SchoolConfigurations_LastModified] DEFAULT (getutcdate()) FOR [LastModified];


GO
PRINT N'Creating [dbo].[FK_A2CTransactionEDIs_A2CTransactions]...';


GO
ALTER TABLE [dbo].[A2CTransactionEDIs] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionEDIs_A2CTransactions] FOREIGN KEY ([SchoolId], [A2CTransactionId]) REFERENCES [dbo].[A2CTransactions] ([SchoolId], [A2CTransactionId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionEDIs_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionEDIs] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionEDIs_AwardingOrganisationCentres] FOREIGN KEY ([AwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionErrors_A2CTransactions]...';


GO
ALTER TABLE [dbo].[A2CTransactionErrors] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionErrors_A2CTransactions] FOREIGN KEY ([SchoolId], [A2CTransactionId]) REFERENCES [dbo].[A2CTransactions] ([SchoolId], [A2CTransactionId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionErrors_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionErrors] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionErrors_AwardingOrganisationCentres] FOREIGN KEY ([AwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionMessages_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionMessages] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionMessages_AwardingOrganisationCentres] FOREIGN KEY ([SchoolId], [A2CTransactionId]) REFERENCES [dbo].[A2CTransactions] ([SchoolId], [A2CTransactionId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionRequests_A2CTransactions]...';


GO
ALTER TABLE [dbo].[A2CTransactionRequests] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionRequests_A2CTransactions] FOREIGN KEY ([SchoolId], [A2CTransactionId]) REFERENCES [dbo].[A2CTransactions] ([SchoolId], [A2CTransactionId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponses_A2CTransactionRequests]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponses] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponses_A2CTransactionRequests] FOREIGN KEY ([SchoolId], [A2CTransactionRequestId]) REFERENCES [dbo].[A2CTransactionRequests] ([SchoolId], [A2CTransactionRequestId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionRequests_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionRequests] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionRequests_AwardingOrganisationCentres] FOREIGN KEY ([AwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionMasters]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionMasters] FOREIGN KEY ([AwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionResponseEnvelopes]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionResponseEnvelopes] FOREIGN KEY ([SchoolId], [A2CTransactionResponseEnvelopeId]) REFERENCES [dbo].[A2CTransactionResponseEnvelopes] ([SchoolId], [A2CTransactionResponseEnvelopeId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseEnvelopeEDIs_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_AwardingOrganisationCentres] FOREIGN KEY ([MessageAwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseEnvelopeMessages_A2CTransactionResponseEnvelopes]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseEnvelopeMessages_A2CTransactionResponseEnvelopes] FOREIGN KEY ([SchoolId], [A2CTransactionResponseEnvelopeId]) REFERENCES [dbo].[A2CTransactionResponseEnvelopes] ([SchoolId], [A2CTransactionResponseEnvelopeId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseEnvelopeMessages_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseEnvelopeMessages_AwardingOrganisationCentres] FOREIGN KEY ([AwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseEnvelopes_A2CTransactionResponses]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopes] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseEnvelopes_A2CTransactionResponses] FOREIGN KEY ([SchoolId], [A2CTransactionResponseId]) REFERENCES [dbo].[A2CTransactionResponses] ([SchoolId], [A2CTransactionResponseId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseEnvelopeSignalErrors_A2CTransactionResponseEnvelopeSignals]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignalErrors] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignalErrors_A2CTransactionResponseEnvelopeSignals] FOREIGN KEY ([SchoolId], [A2CTransactionResponseEnvelopeSignalId]) REFERENCES [dbo].[A2CTransactionResponseEnvelopeSignals] ([SchoolId], [A2CTransactionResponseEnvelopeSignalId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseEnvelopeSignalErrors_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignalErrors] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignalErrors_AwardingOrganisationCentres] FOREIGN KEY ([AwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseEnvelopeSignals_SignalResponseMasters]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignals] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignals_SignalResponseMasters] FOREIGN KEY ([SignalResponseMasterId]) REFERENCES [dbo].[SignalResponseMasters] ([SignalResponseMasterId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseEnvelopeSignals_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignals] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignals_AwardingOrganisationCentres] FOREIGN KEY ([SchoolId], [A2CTransactionResponseEnvelopeId]) REFERENCES [dbo].[A2CTransactionResponseEnvelopes] ([SchoolId], [A2CTransactionResponseEnvelopeId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseErrors_A2CTransactionResponses]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseErrors] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseErrors_A2CTransactionResponses] FOREIGN KEY ([SchoolId], [A2CTransactionResponseId]) REFERENCES [dbo].[A2CTransactionResponses] ([SchoolId], [A2CTransactionResponseId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponseErrors_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponseErrors] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponseErrors_AwardingOrganisationCentres] FOREIGN KEY ([AwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactionResponses_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactionResponses] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactionResponses_AwardingOrganisationCentres] FOREIGN KEY ([AwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactions_AwardingOrganizationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactions] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactions_AwardingOrganizationCentres] FOREIGN KEY ([AwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactions_A2CSchools]...';


GO
ALTER TABLE [dbo].[A2CTransactions] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactions_A2CSchools] FOREIGN KEY ([SchoolId]) REFERENCES [dbo].[A2CSchools] ([A2CSchoolId]);


GO
PRINT N'Creating [dbo].[FK_A2CTransactions_AwardingOrganisationCentres]...';


GO
ALTER TABLE [dbo].[A2CTransactions] WITH NOCHECK
    ADD CONSTRAINT [FK_A2CTransactions_AwardingOrganisationCentres] FOREIGN KEY ([AwardingOrganisationCentreId]) REFERENCES [dbo].[AwardingOrganisationCentres] ([AwardingOrganisationCentreId]);


GO
PRINT N'Creating [dbo].[FK_SchoolConfigurations_A2CSchools]...';


GO
ALTER TABLE [dbo].[SchoolConfigurations] WITH NOCHECK
    ADD CONSTRAINT [FK_SchoolConfigurations_A2CSchools] FOREIGN KEY ([SchoolID]) REFERENCES [dbo].[A2CSchools] ([A2CSchoolId]);


GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionEdis]...';


GO




ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionEdis]
@A2CTransactionId int,
@FileName nvarchar(100)=null,
@AwardingOrganisationCentreId int,
@SchoolId int

AS
BEGIN

Insert into A2CTransactionEDIs (SchoolId,A2CTransactionId,FileName,AwardingOrganisationCentreId)
	values(@SchoolId,@A2CTransactionId,@FileName,@AwardingOrganisationCentreId)

	select cast(SCOPE_IdENTITY() as int)

END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionErrors]...';


GO



 ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionErrors]
@AwardingOrganisationCentreId int,
@A2CTransactionId int,
@ErrorDescription nvarchar(max),
@SchoolId int
AS
BEGIN
	Insert into A2CTransactionErrors (SchoolId,AwardingOrganisationCentreId,A2CTransactionId,ErrorDescription)
	values(@SchoolId,@AwardingOrganisationCentreId,@A2CTransactionId,@ErrorDescription)

	Select cast(SCOPE_IDENTITY() as int)
END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionMessages]...';


GO

ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionMessages]
@A2CTransactionId int,
@AwardingOrganisationCentreId int,
@A2CMessageGuid uniqueidentifier,
@OutgoingSequence bigint,
@SchoolId int
AS
BEGIN

Insert into A2CTransactionMessages (SchoolId,A2CTransactionId,AwardingOrganisationCentreId,A2CMessageGuid,OutgoingSequence)
	values(@SchoolId,@A2CTransactionId,@AwardingOrganisationCentreId,@A2CMessageGuid,@OutgoingSequence)
select cast(SCOPE_IdENTITY() as int)

END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionRequests]...';


GO


ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionRequests]
 @A2CTransactionId int,
@A2CTransactionGuid nvarchar(50),
@EndPoint nvarchar(300),
@Envelope varbinary (max),
@AwardingOrganisationCentreId int,
@SchoolId int 
AS



BEGIN

	Insert into A2CTransactionRequests (SchoolId,A2CTransactionId ,A2CTransactionGuid,EndPoint,Envelope,AwardingOrganisationCentreId)
values(@SchoolId,@A2CTransactionId,@A2CTransactionGuid,@EndPoint,@Envelope,@AwardingOrganisationCentreId)

	select cast(SCOPE_IdENTITY() as int)

END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionResponseEnvelopeEDIs]...';


GO








ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionResponseEnvelopeEDIs]
@AwardingOrganisationCentreId int,
@A2CTransactionResponseEnvelopeId int,
@data varbinary(max) ,
@FileName nvarchar(100),
@AwardingOrganisationNumber nvarchar(200),
@CentreNumber nvarchar(200),
@A2CSchoolId int,
@TransactionName nvarchar(100)=null
AS
BEGIN
	
	DECLARE @A2CTransactionMasterId INT
	Declare @MessageAwardingOrganisationCentreId int
	EXEC @A2CTransactionMasterId= [usp_Select_A2CTransactionMasters_IdByName] @TransactionName

	
	Select @MessageAwardingOrganisationCentreId =aoc.AwardingOrganisationCentreId from AwardingOrganisationCentres aoc
	inner join AwardingOrganisationDetails ad on aoc.AwardingOrganisationDetailId=ad.AwardingOrganisationDetailId
	inner join Centres c on c.CentreId=aoc.CentreId and c.A2CSchoolId=aoc.A2CSchoolId
	where 
	aoc.A2CSchoolId=@A2CSchoolId and
	c.CentreNumber=@CentreNumber and ad.AwardingOrganisationDetailId=aoc.AwardingOrganisationDetailId
	and ad.AONumber=@AwardingOrganisationNumber

	If @MessageAwardingOrganisationCentreId is null
	begin
		Select @CentreNumber = c.CentreNumber, @MessageAwardingOrganisationCentreId =aoc.AwardingOrganisationCentreId from AwardingOrganisationCentres aoc
		inner join AwardingOrganisationDetails ad on aoc.AwardingOrganisationDetailId=ad.AwardingOrganisationDetailId
		inner join Centres c on c.CentreId=aoc.CentreId and c.A2CSchoolId=aoc.A2CSchoolId
		inner join AwardingOrganisationAOAssignedCentres aoassign on aoassign.AwardingOrganisationDetailId=ad.AwardingOrganisationDetailId
		and aoassign.A2CSchoolId=aoc.A2CSchoolId
		where 
		aoc.A2CSchoolId=@A2CSchoolId 
		and ad.AwardingOrganisationDetailId=aoc.AwardingOrganisationDetailId
		and aoassign.AOAssignCentreNumber=@CentreNumber
		and ad.AONumber=@AwardingOrganisationNumber
	end

	Insert into A2CTransactionResponseEnvelopeEDIs (SchoolId,AwardingOrganisationCentreId,A2CTransactionResponseEnvelopeId,[data],FileName, MessageAwardingOrganisationCentreId,A2CTransactionMasterId)
	values(@A2CSchoolId,@AwardingOrganisationCentreId,@A2CTransactionResponseEnvelopeId,@data,@FileName,@MessageAwardingOrganisationCentreId,@A2CTransactionMasterId)
	
	select @CentreNumber
END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionResponseEnvelopeMessages]...';


GO



ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionResponseEnvelopeMessages]
@A2CSchoolId int,
@AwardingOrganisationDetailId int,
@CentreId int,
@A2CTransactionResponseEnvelopeId int,
@MessageId nvarchar(50),
@RefMessageId nvarchar(50)=null,
@TimeStamp datetime,
@TransactionName nvarchar(100)=null,
@IncomingSequence bigint=null,
@data varbinary(max),
@IsFeedbackMessage  bit,
@AwardingOrganisationCentreId int,
@AwardingOrganisationNumber nvarchar(200),
@CentreNumber nvarchar(200),
@IsMessageLevelFeedbackMessage bit
AS
BEGIN
	DECLARE @A2CTransactionMasterId INT
	Declare @MessageAwardingOrganisationCentreId int
	EXEC @A2CTransactionMasterId= [usp_Select_A2CTransactionMasters_IdByName] @TransactionName
	Declare @A2CMessageId int

	Select @MessageAwardingOrganisationCentreId =aoc.AwardingOrganisationCentreId from AwardingOrganisationCentres aoc
	inner join AwardingOrganisationDetails ad on aoc.AwardingOrganisationDetailId=ad.AwardingOrganisationDetailId
	inner join Centres c on c.CentreId=aoc.CentreId and c.A2CSchoolId=aoc.A2CSchoolId
	where 
	aoc.A2CSchoolId=@A2CSchoolId and
	c.CentreNumber=@CentreNumber and ad.AwardingOrganisationDetailId=aoc.AwardingOrganisationDetailId
	and ad.AONumber=@AwardingOrganisationNumber

	If @MessageAwardingOrganisationCentreId is null
	begin
		Select @MessageAwardingOrganisationCentreId =aoc.AwardingOrganisationCentreId from AwardingOrganisationCentres aoc
		inner join AwardingOrganisationDetails ad on aoc.AwardingOrganisationDetailId=ad.AwardingOrganisationDetailId
		inner join Centres c on c.CentreId=aoc.CentreId and c.A2CSchoolId=aoc.A2CSchoolId
		inner join AwardingOrganisationAOAssignedCentres aoassign on aoassign.AwardingOrganisationDetailId=ad.AwardingOrganisationDetailId
		and aoassign.A2CSchoolId=aoc.A2CSchoolId
		where 
		aoc.A2CSchoolId=@A2CSchoolId 
		and ad.AwardingOrganisationDetailId=aoc.AwardingOrganisationDetailId
		and aoassign.AOAssignCentreNumber=@CentreNumber
		and ad.AONumber=@AwardingOrganisationNumber
	end
	--if @RefMessageId<>null and @RefMessageId<>''
	--begin
	--	SELECT @A2CMessageId= A2CMessageId FROM A2CXmlMessages WHERE A2CSchoolId=@A2CSchoolId
	--	AND CentreId=@CentreId AND AwardingOrganisationDetailId=@AwardingOrganisationDetailId AND A2CMessageGuid=@RefMessageId
	--end

	

	Insert into A2CTransactionResponseEnvelopeMessages (SchoolId,A2CTransactionResponseEnvelopeId,MessageId,RefMessageId,[TimeStamp],A2CTransactionMasterId,IncomingSequence,[data],IsFeedbackMessage,A2CMessageId,AwardingOrganisationCentreId,MessageAwardingOrganisationCentreId,IsMessageLevelFeedbackMessage)
	values(@A2CSchoolId,@A2CTransactionResponseEnvelopeId,@MessageId,@RefMessageId,@TimeStamp,@A2CTransactionMasterId,@IncomingSequence,@data,@IsFeedbackMessage,@A2CMessageId,@AwardingOrganisationCentreId,@MessageAwardingOrganisationCentreId,@IsMessageLevelFeedbackMessage)
	select cast(SCOPE_IdENTITY() as int)

	if @IncomingSequence is not null and @IncomingSequence>0 and @MessageAwardingOrganisationCentreId>0
	begin
		update AwardingOrganisationCentres
		set IncomingSequence=@IncomingSequence
		where AwardingOrganisationCentreId = @MessageAwardingOrganisationCentreId
	end
END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionResponseEnvelopes]...';


GO



ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionResponseEnvelopes]
@A2CTransactionResponseId int,
@IsSignalMessage bit,
@ResponseEnvelope varbinary(max) ,
@IsEDIMessage bit,
@AwardingOrganisationCentreId int,
@SchoolId int
AS
BEGIN
	Insert into A2CTransactionResponseEnvelopes (SchoolId,A2CTransactionResponseId,IsSignalMessage,ResponseEnvelope,IsEDIMessage,AwardingOrganisationCentreId)
	values(@SchoolId,@A2CTransactionResponseId,@IsSignalMessage
	,@ResponseEnvelope,@IsEDIMessage,@AwardingOrganisationCentreId)

SELECT CAST(SCOPE_IdENTITY() AS INT)

END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionResponseEnvelopeSignalErrors]...';


GO


 ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionResponseEnvelopeSignalErrors] 
@A2CTransactionResponseEnvelopeSignalId int,
@ErrorCode nvarchar(50)=null,
@ErrorDetail nvarchar(max)=null,
@Origin nvarchar(max)=null,
@RefMessageId nvarchar(50)=null,
@Severity nvarchar(50)=null,
@ShortDescription nvarchar(50)=null,
@Category nvarchar(50)=null,
@Description nvarchar(max)=null,
@AwardingOrganisationCentreId int ,
@SchoolId int
AS
BEGIN
	Insert into A2CTransactionResponseEnvelopeSignalErrors (SchoolId,A2CTransactionResponseEnvelopeSignalId,ErrorCode,ErrorDetail,Origin,RefMessageId,Severity,ShortDescription,Category,Description,AwardingOrganisationCentreId)
	values(@SchoolId,@A2CTransactionResponseEnvelopeSignalId,@ErrorCode,@ErrorDetail,@Origin,@RefMessageId,@Severity,@ShortDescription,@Category,@Description,@AwardingOrganisationCentreId)
	SELECT CAST(SCOPE_IdENTITY() AS int)
END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionResponseEnvelopeSignals]...';


GO


 ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionResponseEnvelopeSignals]
@A2CTransactionResponseEnvelopeId int,
@SignalResponseMasterId int,
@AwardingOrganisationCentreId int,
@SchoolId int
AS
BEGIN
	Insert into A2CTransactionResponseEnvelopeSignals (SchoolId,A2CTransactionResponseEnvelopeId,SignalResponseMasterId,AwardingOrganisationCentreId)
	values(@SchoolId,@A2CTransactionResponseEnvelopeId,@SignalResponseMasterId,@AwardingOrganisationCentreId)

	select cast(SCOPE_IdENTITY() as int)
END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionResponseErrors]...';


GO


ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionResponseErrors]
@A2CTransactionResponseId int,
@AwardingOrganisationCentreId int,
@ErrorDescription nvarchar(max),
@SchoolId int
AS
BEGIN
	Insert into A2CTransactionResponseErrors (SchoolId,A2CTransactionResponseId,AwardingOrganisationCentreId,ErrorDescription)
	values(@SchoolId,@A2CTransactionResponseId,@AwardingOrganisationCentreId,@ErrorDescription)

select cast(scope_identity() as int)

END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactionResponses]...';


GO

ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactionResponses] 
@A2CTransactionRequestId int,
@TransactionResponseStatus nvarchar(200),
@AwardingOrganisationCentreId int,
@IsErrorAssociated bit,
@SchoolId int
AS
BEGIN
	Insert into A2CTransactionResponses (SchoolId,A2CTransactionRequestId,TransactionResponseStatus,AwardingOrganisationCentreId,IsErrorAssociated)
	values(@SchoolId,@A2CTransactionRequestId,@TransactionResponseStatus,@AwardingOrganisationCentreId,@IsErrorAssociated)
	Select cast(SCOPE_IdENTITY() as int)

END
GO
PRINT N'Altering [dbo].[usp_Insert_A2CTransactions]...';


GO


ALTER PROCEDURE [dbo].[usp_Insert_A2CTransactions]
@TransactionName nvarchar(100)=null,
@AwardingOrganisationCentreId int,
@SchoolId int
AS



BEGIN



DECLARE @A2CTransactionMasterId INT

	EXEC @A2CTransactionMasterId= [usp_Select_A2CTransactionMasters_IdByName] @TransactionName
	Insert into A2CTransactions (SchoolId,A2CTransactionMasterId,AwardingOrganisationCentreId)
	values(@SchoolId,@A2CTransactionMasterId,@AwardingOrganisationCentreId)

	select cast(SCOPE_IdENTITY() as int)

END
GO
PRINT N'Altering [dbo].[usp_GetSMTPProviderDetails]...';


GO
ALTER PROCEDURE [dbo].[usp_GetSMTPProviderDetails]
	@SchoolId int = NULL,
	@ApplicationName varchar(Max)
AS
BEGIN

    SET NOCOUNT ON;	

	DECLARE @SSURECORDEXIST BIT = 0
	DECLARE @SCHOOLRECORDEXISTS BIT = 0
	DECLARE @ISFACILITY BIT = 0 --this parameter is only used for Facility

	IF UPPER(LTRIM(RTRIM(ISNULL(@ApplicationName,'')))) = 'FACILITY'
	BEGIN
		SET @ISFACILITY = 1		
	END

	IF EXISTS (SELECT * FROM dbo.SMTPEmailProviders WHERE SchoolId is null)
	BEGIN
		SET @SSURECORDEXIST = 1
	END

	IF EXISTS (SELECT * FROM dbo.SMTPEmailProviders WHERE SchoolId = @SchoolId)
	BEGIN
		SET @SCHOOLRECORDEXISTS = 1
	END
	
	--GET RECORD FOR SSU
	IF @SSURECORDEXIST = 1
	BEGIN		
		SELECT TOP 1
			ISNULL(SP.HostName,'') as Host, ISNULL(SP.Port,0) AS Port,ISNULL(SP.UserName,'') AS UserName,ISNULL(SP.[Password],'') AS [Password],
			ISNULL(SP.FromEmail,'') AS FromEmail,SP.SchoolId,ISNULL(SP.[AuthenticationRequired],0) AS AuthenticationRequired
		INTO
			#SSU			
		FROM
			dbo.SMTPEmailProviders SP         
		WHERE
			SP.SchoolId is null	
		ORDER BY 
			SP.SMTPEmailProviderId ASC
	END

	--SELECT DATA AS PER EMAIL CONFIGURATION CHOICE AND APPLICATION(FACILITY/PROGRESSO)
	IF @SchoolId IS NULL
	BEGIN
		IF @SSURECORDEXIST = 1
			SELECT * FROM #SSU
		ELSE
		BEGIN			
			IF @ISFACILITY = 1
			BEGIN
				--IN CASE OF FACILITY, ANY RECORD EXISTING IN TABLE IS USED FOR EMAIL SENDING
				SELECT TOP 1
					ISNULL(SP.HostName,'') as Host, ISNULL(SP.Port,0) AS Port,ISNULL(SP.UserName,'') AS UserName,ISNULL(SP.[Password],'') AS [Password],
					ISNULL(SP.FromEmail,'') AS FromEmail,SP.SchoolId,ISNULL(SP.[AuthenticationRequired],0) AS [AuthenticationRequired],
					CASE @ISFACILITY WHEN 1 THEN ISNULL(SP.[EmailConfigurationChoice],1) ELSE ISNULL(SP.[EmailConfigurationChoice],2) END AS [EmailConfigurationChoice]				
				FROM   
					dbo.SMTPEmailProviders SP 				
				ORDER BY 
					SP.SMTPEmailProviderId ASC
			END
			ELSE
			BEGIN
				--IN CASE OF PROGRESSO
				RETURN
			END
		END
	END
	ELSE
	BEGIN
		IF @SCHOOLRECORDEXISTS = 0
		BEGIN
			--NO RECORD EXIST AT SCHOOL LEVEL, SELECT SSU DETAILS
			IF @SSURECORDEXIST = 1
				SELECT * FROM #SSU
			ELSE				
				RETURN
		END
		ELSE
		BEGIN
			--RECORD EXISTS AT SCHOOL LEVEL
			SELECT TOP 1
				ISNULL(SP.HostName,'') as Host, ISNULL(SP.Port,0) AS Port,ISNULL(SP.UserName,'') AS UserName,ISNULL(SP.[Password],'') AS [Password],
				ISNULL(SP.FromEmail,'') AS FromEmail,SP.SchoolId,ISNULL(SP.[AuthenticationRequired],0) AS [AuthenticationRequired],
				CASE @ISFACILITY WHEN 1 THEN ISNULL(SP.[EmailConfigurationChoice],1) ELSE ISNULL(SP.[EmailConfigurationChoice],2) END AS [EmailConfigurationChoice]
			INTO
				#SCHOOL
			FROM   
				dbo.SMTPEmailProviders SP 
			WHERE  
				SP.SchoolId = @SchoolId
			ORDER BY 
				SP.SMTPEmailProviderId ASC

			--NOW SELECT DATA AS PER SCHOOL CONFIGURATION CHOICE
			IF (SELECT [EmailConfigurationChoice] FROM #SCHOOL) = 1 --SMTP OPTION SELECTED
			BEGIN
				SELECT * FROM #SCHOOL
			END			
			ELSE IF (SELECT [EmailConfigurationChoice] FROM #SCHOOL) = 2 --AMAZON CLOUD OPTION SELECTED
			BEGIN	
				IF @SSURECORDEXIST = 1	
				BEGIN		
					--SELECT ALL DETAILS OF SSU EXCEPT EMAID ADDRESS
					UPDATE #SSU SET FromEmail = S.FromEmail FROM #SCHOOL S	
					SELECT * FROM #SSU
				END
				ELSE
					--SELECT NULL
					RETURN
			END			
			ELSE  --NONE OPTION SELECTED
			BEGIN
				IF @SSURECORDEXIST = 1
					SELECT * FROM #SSU
				ELSE
					--SELECT NULL
					RETURN
			END
		END
	END
END
GO
PRINT N'Creating [dbo].[usp_CheckSMTPConfigured]...';


GO
CREATE PROCEDURE [dbo].[usp_CheckSMTPConfigured]	
	@ApplicationName varchar(Max),
	@IsRecordExist bit Output
AS
BEGIN
    SET NOCOUNT ON;		

	Set @IsRecordExist = 0

	IF UPPER(LTRIM(RTRIM(ISNULL(@ApplicationName,'')))) = 'FACILITY'		
	BEGIN
		--this parameter is only used for Facility
		IF EXISTS (SELECT * FROM dbo.SMTPEmailProviders)
		BEGIN
			Set @IsRecordExist = 1			
		END
		ELSE
		BEGIN
			Set @IsRecordExist = 0
		END
	END	
END
GO
PRINT N'Creating [dbo].[usp_GetErrorLogDetails]...';


GO
CREATE PROCEDURE usp_GetErrorLogDetails
	@SchoolId INT = NULL,
	@ErrorLogId INT = 0
AS
BEGIN
	SELECT
		E.ErrorLogId,
		E.ErrorMessage AS [Description]
	FROM 
		ErrorLogs E
	WHERE
		E.ErrorLogId = ISNULL(@ErrorLogId,0) AND
		ISNULL(E.A2CSchoolId,0) = ISNULL(@SchoolId,0)
END
GO
PRINT N'Creating [dbo].[usp_GetSchoolConfigurations]...';


GO


CREATE PROCEDURE [dbo].[usp_GetSchoolConfigurations]
@SchoolID INT
AS   
BEGIN


SELECT [SchoolConfigurationId]
      ,[SchoolID]
      ,[ContactEmail]
      ,[ContactPhoneNumber]
      ,[NumberofAttemptCheckForAOConnection]
      ,[LastModified]
  FROM [dbo].[SchoolConfigurations]
  WHERE [SchoolID] = @SchoolID


 END
GO
PRINT N'Creating [dbo].[USP_UpdateSchoolConfiguration]...';


GO

CREATE PROCEDURE [dbo].[USP_UpdateSchoolConfiguration]

@FieldNames NVARCHAR (MAX),
@FieldValues NVARCHAR (MAX),
@Delimiter VARCHAR(1),
@SchoolId INT,
@SchoolConfigurationId INT
AS

BEGIN

    SET NOCOUNT ON;

	DECLARE @FieldName NVARCHAR(MAX);
	DECLARE @posFieldName INT;
	DECLARE @posFieldValue INT;
	DECLARE @FieldValue NVARCHAR(MAX);
	Declare @stringToSplitFieldName NVARCHAR (MAX);
	DECLARE @stringToSplitFieldValue NVARCHAR (MAX);
	DECLARE @UpdatedFileds NVARCHAR (MAX);
		
	DECLARE @UpdateSQL NVARCHAR(MAX);
	Set @stringToSplitFieldName=@FieldNames;
	Set @stringToSplitFieldValue=@FieldValues;

	SET @UpdatedFileds = '';
	WHILE LEN(@stringToSplitFieldName) > 0
	BEGIN

		SELECT @posFieldName  = CHARINDEX(@Delimiter, @stringToSplitFieldName)
		SELECT @posFieldValue  = CHARINDEX(@Delimiter, @stringToSplitFieldValue)

		if @posFieldName = 0
			Begin
				SELECT @posFieldName = LEN(@stringToSplitFieldName)
				SELECT @FieldName = SUBSTRING(@stringToSplitFieldName, 1, @posFieldName)
				SELECT @posFieldValue = LEN(@stringToSplitFieldValue)
				SELECT @FieldValue = SUBSTRING(@stringToSplitFieldValue, 1, @posFieldValue)
			End
		Else
			Begin
				SELECT @FieldName = SUBSTRING(@stringToSplitFieldName, 1, @posFieldName-1)
				SELECT @FieldValue = SUBSTRING(@stringToSplitFieldValue, 1, @posFieldValue-1)
			End

		if(len(@UpdatedFileds) > 0)
		SET @UpdatedFileds = @UpdatedFileds + ', '
		 SET @UpdatedFileds = @UpdatedFileds + @FieldName + ' = ''' + @FieldValue + '''';
			
		SELECT @stringToSplitFieldName = SUBSTRING(@stringToSplitFieldName, @posFieldName+1, LEN(@stringToSplitFieldName)-@posFieldName)
		SELECT @stringToSplitFieldValue = SUBSTRING(@stringToSplitFieldValue, @posFieldValue+1, LEN(@stringToSplitFieldValue)-@posFieldValue)
	END
	
	SET @UpdateSQL = 'UPDATE	[dbo].[SchoolConfigurations] SET ' + @UpdatedFileds +', [LastModified] = GETUTCDATE()
						WHERE SchoolConfigurationId = ' + cast(@SchoolConfigurationId as nvarchar(100)) +' AND SchoolId = ' + cast(@SchoolId as nvarchar(100))
	
	EXEC( @UpdateSQL)
	
END
GO
PRINT N'Creating [dbo].[A2CTransactionResponseEnvelopeMessages].[DataImportStatus].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'0-not imported, 1-imported successfully, 2-imported with error', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'A2CTransactionResponseEnvelopeMessages', @level2type = N'COLUMN', @level2name = N'DataImportStatus';


GO
PRINT N'Altering [Version]...';


GO
EXECUTE sp_updateextendedproperty @name = N'Version', @value = N'15.1.6.2';


GO
PRINT N'Refreshing [dbo].[USP_IMPORTPRODUCTCATALOGE]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_IMPORTPRODUCTCATALOGE]';


GO
/*
Post-Deployment Script Template							
--------------------------------------------------------------------------------------
 This file contains SQL statements that will be appended to the build script.		
 Use SQLCMD syntax to include a file in the post-deployment script.			
 Example:      :r .\myfile.sql								
 Use SQLCMD syntax to reference a variable in the post-deployment script.		
 Example:      :setvar TableName MyTable							
               SELECT * FROM [$(TableName)]					
--------------------------------------------------------------------------------------
*/

Insert into ScreenMasters(ScreenMasterId, ScreenName,ScreenDescription)
Select	temp.ScreenMasterId, temp.ScreenName,temp.ScreenDescription
From	(Select 1018 ScreenMasterId, 'SchoolApplicationConfiguration' ScreenName,'School Application Configuration' ScreenDescription
		union all
		Select 1019, 'BusinessErrorLog','Business Error Log'
		) As temp
		Left Join ScreenMasters sm 
		on temp.ScreenMasterId = sm.ScreenMasterId
Where sm.ScreenMasterId is null

--Insert Default Value in System Configurations 

DECLARE @SystemConfigurationId INT
DECLARE @A2CApplicationURL NVARCHAR(2083)
DECLARE @ContactEmail NVARCHAR(256)
DECLARE @ContactPhoneNumber NVARCHAR(50)
DECLARE @PickUpFileFromEDIFolderInMinutes SMALLINT
DECLARE @SendA2CRequestInMinutes SMALLINT
DECLARE @PollingInMinutes SMALLINT

SET	@A2CApplicationURL = 'https://a2c.abhsindia.local:4431/Account/LogOn'
SET	@ContactEmail = 'a2capplication-admin@a2ccore.net'
SET @ContactPhoneNumber = '08456888400'
SET @PickUpFileFromEDIFolderInMinutes = 5
SET @SendA2CRequestInMinutes = 5
SET @PollingInMinutes = 60

SELECT @SystemConfigurationId = SystemConfigurationId FROM SystemConfigurations

IF ISNULL(@SystemConfigurationId, 0) = 0
BEGIN
	INSERT INTO [dbo].[SystemConfigurations]([A2CApplicationURL], [ContactEmail], [ContactPhoneNumber], [PickUpFileFromEDIFolderInMinutes], [SendA2CRequestInMinutes],
												[PollingInMinutes])
     VALUES
           (@A2CApplicationURL, @ContactEmail, @ContactPhoneNumber, @PickUpFileFromEDIFolderInMinutes, @SendA2CRequestInMinutes, @PollingInMinutes)
END


--Insert Default Value in School Configurations 

--DECLARE @SchoolConfigurationId INT
--DECLARE @SchoolID INT
--DECLARE @ContactEmailSchool NVARCHAR(256)
--DECLARE @ContactPhoneNumberSchool NVARCHAR(50)
--DECLARE @NumberofAttemptCheckForAOConnection SMALLINT

--SET	@SchoolID = 1000
--SET	@ContactEmailSchool = 'a2capplication-admin@a2ccore.net'
--SET @ContactPhoneNumberSchool = '08456888400'
--SET @NumberofAttemptCheckForAOConnection = 5

--SELECT @SchoolConfigurationId = SchoolConfigurationId FROM SchoolConfigurations WHERE SchoolID = @SchoolID

--IF ISNULL(@SchoolConfigurationId, 0) = 0
--BEGIN

--		INSERT INTO [dbo].[SchoolConfigurations]([SchoolID], [ContactEmail], [ContactPhoneNumber], [NumberofAttemptCheckForAOConnection], [LastModified])
--		VALUES(@SchoolID, @ContactEmailSchool, @ContactPhoneNumberSchool, @NumberofAttemptCheckForAOConnection, GETUTCDATE())
		
--END


GO


if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactions' AND Type = N'U')
begin

SET IDENTITY_INSERT A2CTransactions on
INSERT INTO [dbo].[A2CTransactions]
           ([A2CTransactionId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionMasterId]
           ,[LastModifiedDate],
		   SchoolId)
SELECT [A2CTransactionId]
      ,t.AwardingOrganisationCentreId
      ,[A2CTransactionMasterId]
      ,t.LastModifiedDate
	  ,c.A2CSchoolId
  FROM [dbo].[tmpA2CTransactions] t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId

  Drop table tmpA2CTransactions

  SET IDENTITY_INSERT A2CTransactions off

 end


 if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionMessages' AND Type = N'U')
begin

  SET IDENTITY_INSERT A2CTransactionMessages on

INSERT INTO [dbo].[A2CTransactionMessages]
           ([A2CTransactionMessageId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionId]
           ,[A2CMessageGuid]
           ,[OutgoingSequence]
           ,[LastModifiedDate]
		   ,SchoolId
		   )
    SELECT [A2CTransactionMessageId]
      ,t.AwardingOrganisationCentreId
      ,[A2CTransactionId]
      ,[A2CMessageGuid]
      ,t.[OutgoingSequence]
      ,t.LastModifiedDate
	  ,c.A2CSchoolId
  FROM [dbo].[tmpA2CTransactionMessages]  
  t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId

  SET IDENTITY_INSERT A2CTransactionMessages off
  drop table tmpA2CTransactionMessages
  end


   if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionEDIs' AND Type = N'U')
begin

    SET IDENTITY_INSERT A2CTransactionEDIs on

  INSERT INTO [dbo].[A2CTransactionEDIs]
           ([A2CTransactionEDIId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionId]
           ,[LastModifiedDate]
           ,[FileName]
		   ,SchoolId
		   )
   SELECT [A2CTransactionEDIId]
      ,t.AwardingOrganisationCentreId
      ,[A2CTransactionId]
      ,t.LastModifiedDate
      ,[FileName]
	  ,c.A2CSchoolId
	FROM [dbo].[tmpA2CTransactionEDIs]
  t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId

	  SET IDENTITY_INSERT A2CTransactionEDIs off
	  drop table tmpA2CTransactionEDIs
end



   if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionErrors' AND Type = N'U')
begin

	  SET IDENTITY_INSERT A2CTransactionErrors on

	    INSERT INTO [dbo].[A2CTransactionErrors]
           ([A2CTransactionErrorId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionId]
           ,[ErrorDescription]
           ,[LastModifiedDate]
		   ,SchoolId
		   )
    SELECT [A2CTransactionErrorId]
      ,t.AwardingOrganisationCentreId
      ,[A2CTransactionId]
      ,[ErrorDescription]
      ,t.LastModifiedDate
	   ,c.A2CSchoolId
  FROM [dbo].[tmpA2CTransactionErrors]
   t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId

    

   SET IDENTITY_INSERT A2CTransactionErrors off
   drop table tmpA2CTransactionErrors
   end


   
   if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionRequests' AND Type = N'U')
begin

   SET IDENTITY_INSERT A2CTransactionRequests on

   declare @A2CTransactionRequestId  int  
select @A2CTransactionRequestId = min(AR.A2CTransactionRequestId) from tmpA2CTransactionRequests
AR 
While(exists(select 1 from tmpA2CTransactionRequests where A2CTransactionRequestId>=@A2CTransactionRequestId))
begin
declare @A2CTransactionRequestIdMin int
declare @A2CTransactionRequestIdMax int
set @A2CTransactionRequestIdMin= @A2CTransactionRequestId 
set @A2CTransactionRequestIdMax= @A2CTransactionRequestId + 999

INSERT INTO [dbo].[A2CTransactionRequests]
           ([A2CTransactionRequestId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionId]
           ,[A2CTransactionGuid]
           ,[EndPoint]
           ,[LastModifiedDate]
           ,[Id]
           ,[Envelope]
		   ,SchoolId)
  SELECT [A2CTransactionRequestId]
      ,t.[AwardingOrganisationCentreId]
      ,[A2CTransactionId]
      ,[A2CTransactionGuid]
      ,[EndPoint]
      ,t.[LastModifiedDate]
      ,[Id]
      ,[Envelope]
	  ,c.A2CSChoolId
  FROM [dbo].[tmpA2CTransactionRequests]  t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId

  WHERE A2CTransactionRequestId >= @A2CTransactionRequestIdMin and
  A2CTransactionRequestId <=@A2CTransactionRequestIdMax

  set @A2CTransactionRequestId = @A2CTransactionRequestId + 1000
  
  END


  drop table tmpA2CTransactionRequests
  SET IDENTITY_INSERT A2CTransactionRequests off
  end
  

  

  if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponses' AND Type = N'U')
begin

    SET IDENTITY_INSERT A2CTransactionResponses on

    INSERT INTO [dbo].[A2CTransactionResponses]
             ([A2CTransactionResponseId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionRequestId]
           ,[TransactionResponseStatus]
           ,[LastModifiedDate]
           ,[IsErrorAssociated]
		   ,SchoolId
		   )
   SELECT [A2CTransactionResponseId]
      ,t.AwardingOrganisationCentreId
      ,[A2CTransactionRequestId]
      ,[TransactionResponseStatus]
      ,t.LastModifiedDate
      ,[IsErrorAssociated]
	   ,c.A2CSchoolId
  FROM [dbo].[tmpA2CTransactionResponses]
     t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId


    SET IDENTITY_INSERT A2CTransactionResponses off

	drop table tmpA2CTransactionResponses

	end

	if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseErrors' AND Type = N'U')
begin

	 SET IDENTITY_INSERT A2CTransactionResponseErrors on

	  INSERT INTO [dbo].[A2CTransactionResponseErrors]
           ([A2CTransactionResponseErrorId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseId]
           ,[ErrorDescription]
           ,[LastModifiedDate]
		   ,SchoolId)
    SELECT [A2CTransactionResponseErrorId]
      ,t.AwardingOrganisationCentreId
      ,[A2CTransactionResponseId]
      ,[ErrorDescription]
      ,t.LastModifiedDate
	   ,c.A2CSchoolId
  FROM [dbo].[tmpA2CTransactionResponseErrors]
     t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId


  
    SET IDENTITY_INSERT A2CTransactionResponseErrors off

	drop table tmpA2CTransactionResponseErrors
	end


	if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseEnvelopes' AND Type = N'U')
begin

	    SET IDENTITY_INSERT A2CTransactionResponseEnvelopes on
	
	
declare @A2CTransactionResponseEnvelopeId  int  
select @A2CTransactionResponseEnvelopeId = min(ARE.A2CTransactionResponseEnvelopeId) from 
tmpA2CTransactionResponseEnvelopes ARE 
  
While(exists(select 1 from tmpA2CTransactionResponseEnvelopes where A2CTransactionResponseEnvelopeId>=@A2CTransactionResponseEnvelopeId))
begin
declare @A2CTransactionResponseEnvelopeIdMin int
declare @A2CTransactionResponseEnvelopeIdMax int
set @A2CTransactionResponseEnvelopeIdMin= @A2CTransactionResponseEnvelopeId 
set @A2CTransactionResponseEnvelopeIdMax= @A2CTransactionResponseEnvelopeId + 999

INSERT INTO [dbo].[A2CTransactionResponseEnvelopes]
           ([A2CTransactionResponseEnvelopeId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseId]
           ,[IsSignalMessage]
           ,[LastModifiedDate]
           ,[Id]
           ,[ResponseEnvelope]
           ,[IsEDIMessage],
		   SchoolId)
     SELECT [A2CTransactionResponseEnvelopeId]
      ,t.[AwardingOrganisationCentreId]
      ,[A2CTransactionResponseId]
      ,[IsSignalMessage]
      ,t.[LastModifiedDate]
      ,[Id]
      ,[ResponseEnvelope]
      ,[IsEDIMessage]
  ,c.A2CSChoolId
    FROM [dbo].[tmpA2CTransactionResponseEnvelopes]
  t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId

  WHERE A2CTransactionResponseEnvelopeId >= @A2CTransactionResponseEnvelopeIdMin and
  A2CTransactionResponseEnvelopeId <=@A2CTransactionResponseEnvelopeIdMax

  set @A2CTransactionResponseEnvelopeId = @A2CTransactionResponseEnvelopeId + 1000
  
  END

      SET IDENTITY_INSERT A2CTransactionResponseEnvelopes off
	  drop table tmpA2CTransactionResponseEnvelopes
	  end


	  if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseEnvelopeSignals' AND Type = N'U')
begin

      SET IDENTITY_INSERT A2CTransactionResponseEnvelopeSignals on

INSERT INTO [dbo].[A2CTransactionResponseEnvelopeSignals]
           ([A2CTransactionResponseEnvelopeSignalId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseEnvelopeId]
           ,[SignalResponseMasterId]
           ,[LastModifiedDate]
		   ,SchoolId
		   )
    SELECT [A2CTransactionResponseEnvelopeSignalId]
      ,t.AwardingOrganisationCentreId
      ,[A2CTransactionResponseEnvelopeId]
      ,[SignalResponseMasterId]
      ,t.LastModifiedDate
	  , c.A2CSchoolId
  FROM [dbo].[tmpA2CTransactionResponseEnvelopeSignals]
   t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId

  drop table tmpA2CTransactionResponseEnvelopeSignals

        SET IDENTITY_INSERT A2CTransactionResponseEnvelopeSignals off
end

  if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseEnvelopeSignalErrors' AND Type = N'U')
begin

		 SET IDENTITY_INSERT A2CTransactionResponseEnvelopeSignalErrors on
		
  INSERT INTO [dbo].[A2CTransactionResponseEnvelopeSignalErrors]
           ([A2CTransactionResponseEnvelopeSignalErrorId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseEnvelopeSignalId]
           ,[ErrorCode]
           ,[ErrorDetail]
           ,[Origin]
           ,[RefMessageId]
           ,[Severity]
           ,[ShortDescription]
           ,[Category]
           ,[Description]
           ,[LastModifiedDate]
		    , SchoolId
		   )
   SELECT [A2CTransactionResponseEnvelopeSignalErrorId]
      ,t.AwardingOrganisationCentreId
      ,[A2CTransactionResponseEnvelopeSignalId]
      ,[ErrorCode]
      ,[ErrorDetail]
      ,[Origin]
      ,[RefMessageId]
      ,[Severity]
      ,[ShortDescription]
      ,[Category]
      ,[Description]
      ,t.LastModifiedDate
	  , c.A2CSchoolId
  FROM [dbo].[tmpA2CTransactionResponseEnvelopeSignalErrors]
   t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId

   SET IDENTITY_INSERT A2CTransactionResponseEnvelopeSignalErrors off

   drop table tmpA2CTransactionResponseEnvelopeSignalErrors
   end


   
  if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseEnvelopeEDIs' AND Type = N'U')
begin

      SET IDENTITY_INSERT A2CTransactionResponseEnvelopeEDIs on

INSERT INTO [dbo].[A2CTransactionResponseEnvelopeEDIs]
           ([A2CTransactionResponseEnvelopeEDIId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseEnvelopeId]
           ,[FileName]
           ,[LastModifiedDate]
           ,[Id]
           ,[data]
           ,[MessageAwardingOrganisationCentreId]
		   ,SchoolId
		   ,A2CTransactionMasterId
		   )
     SELECT [A2CTransactionResponseEnvelopeEDIId]
      ,t.AwardingOrganisationCentreId
      ,[A2CTransactionResponseEnvelopeId]
      ,[FileName]
      ,t.LastModifiedDate
      ,[Id]
      ,[data]
      ,[MessageAwardingOrganisationCentreId]
	  , c.A2CSchoolId
	  ,t.A2CTransactionMasterId
  FROM [dbo].[tmpA2CTransactionResponseEnvelopeEDIs]
     t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId

     SET IDENTITY_INSERT A2CTransactionResponseEnvelopeEDIs off

	 drop table tmpA2CTransactionResponseEnvelopeEDIs

	 end 


	 if EXISTS(SELECT 1 FROM sys.Tables WHERE  Name = N'tmpA2CTransactionResponseEnvelopeMessages' AND Type = N'U')
begin


declare @A2CTransactionResponseEnvelopeMessageId int
select @A2CTransactionResponseEnvelopeMessageId= min(t.A2CTransactionResponseEnvelopeMessageId) 
  FROM [dbo].[tmpA2CTransactionResponseEnvelopeMessages]  t  

	    SET IDENTITY_INSERT A2CTransactionResponseEnvelopeMessages on
		 

While(exists(select 1 from tmpA2CTransactionResponseEnvelopeMessages where A2CTransactionResponseEnvelopeMessageId>=@A2CTransactionResponseEnvelopeMessageId))
begin

declare @A2CTransactionResponseEnvelopeMessageIdMin int
declare @A2CTransactionResponseEnvelopeMessageIdMax int
set @A2CTransactionResponseEnvelopeMessageIdMin= @A2CTransactionResponseEnvelopeMessageId 
set @A2CTransactionResponseEnvelopeMessageIdMax= @A2CTransactionResponseEnvelopeMessageId + 1

INSERT INTO [dbo].[A2CTransactionResponseEnvelopeMessages]
           ([A2CTransactionResponseEnvelopeMessageId]
           ,[AwardingOrganisationCentreId]
           ,[A2CTransactionResponseEnvelopeId]
           ,[MessageId]
           ,[RefMessageId]
           ,[TimeStamp]
           ,[A2CMessageId]
           ,[A2CTransactionMasterId]
           ,[IncomingSequence]
           ,[LastModifiedDate]
           ,[Id]
           ,[data]
           ,[IsFeedbackMessage]
           ,[DataImportStatus]
           ,[MessageAwardingOrganisationCentreId]
           ,[IsMessageLevelFeedbackMessage],SchoolId)
   SELECT [A2CTransactionResponseEnvelopeMessageId]
      ,t.[AwardingOrganisationCentreId]
      ,[A2CTransactionResponseEnvelopeId]
      ,[MessageId]
      ,[RefMessageId]
      ,[TimeStamp]
      ,[A2CMessageId]
      ,[A2CTransactionMasterId]
      ,t.[IncomingSequence]
      ,t.[LastModifiedDate]
      ,[Id]
      ,[data]
      ,[IsFeedbackMessage]
      ,[DataImportStatus]
      ,[MessageAwardingOrganisationCentreId]
      ,[IsMessageLevelFeedbackMessage],
	  C.A2CSchoolId
  FROM [dbo].[tmpA2CTransactionResponseEnvelopeMessages]
  t
  join AwardingOrganisationCentres c on c.AwardingOrganisationCentreId= t.AwardingOrganisationCentreId
  where 
  A2CTransactionResponseEnvelopeMessageId >= @A2CTransactionResponseEnvelopeMessageIdMin
  and 
  A2CTransactionResponseEnvelopeMessageId <= @A2CTransactionResponseEnvelopeMessageIdMax
  
   set  @A2CTransactionResponseEnvelopeMessageId =  @A2CTransactionResponseEnvelopeMessageId + 2
  
end



SET IDENTITY_INSERT A2CTransactionResponseEnvelopeMessages off
drop table tmpA2CTransactionResponseEnvelopeMessages
end











GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[A2CTransactionEDIs] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionEDIs_A2CTransactions];

ALTER TABLE [dbo].[A2CTransactionEDIs] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionEDIs_AwardingOrganisationCentres];

ALTER TABLE [dbo].[A2CTransactionErrors] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionErrors_A2CTransactions];

ALTER TABLE [dbo].[A2CTransactionErrors] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionErrors_AwardingOrganisationCentres];

ALTER TABLE [dbo].[A2CTransactionMessages] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionMessages_AwardingOrganisationCentres];

ALTER TABLE [dbo].[A2CTransactionRequests] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionRequests_A2CTransactions];

ALTER TABLE [dbo].[A2CTransactionResponses] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponses_A2CTransactionRequests];

ALTER TABLE [dbo].[A2CTransactionRequests] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionRequests_AwardingOrganisationCentres];

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionMasters];

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_A2CTransactionResponseEnvelopes];

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeEDIs] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseEnvelopeEDIs_AwardingOrganisationCentres];

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseEnvelopeMessages_A2CTransactionResponseEnvelopes];

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeMessages] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseEnvelopeMessages_AwardingOrganisationCentres];

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopes] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseEnvelopes_A2CTransactionResponses];

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignalErrors] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignalErrors_A2CTransactionResponseEnvelopeSignals];

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignalErrors] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignalErrors_AwardingOrganisationCentres];

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignals] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignals_SignalResponseMasters];

ALTER TABLE [dbo].[A2CTransactionResponseEnvelopeSignals] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseEnvelopeSignals_AwardingOrganisationCentres];

ALTER TABLE [dbo].[A2CTransactionResponseErrors] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseErrors_A2CTransactionResponses];

ALTER TABLE [dbo].[A2CTransactionResponseErrors] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponseErrors_AwardingOrganisationCentres];

ALTER TABLE [dbo].[A2CTransactionResponses] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactionResponses_AwardingOrganisationCentres];

ALTER TABLE [dbo].[A2CTransactions] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactions_AwardingOrganizationCentres];

ALTER TABLE [dbo].[A2CTransactions] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactions_A2CSchools];

ALTER TABLE [dbo].[A2CTransactions] WITH CHECK CHECK CONSTRAINT [FK_A2CTransactions_AwardingOrganisationCentres];

ALTER TABLE [dbo].[SchoolConfigurations] WITH CHECK CHECK CONSTRAINT [FK_SchoolConfigurations_A2CSchools];


GO
PRINT N'Update complete.';


GO
